<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Ddup">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Ddup">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ddup">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> Ddup </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ddup</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/30/linux-nei-cun-guan-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/30/linux-nei-cun-guan-li/" itemprop="url">
                  Linux 内存管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-30T20:43:11+08:00">
                2016-11-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##内存管理</p>
<p>###内存管理逻辑概念</p>
<ul>
<li>逻辑地址：是在机器语言指令中,来说明操作数和指令的地址;每个逻辑地址包括两部分:段(Segment)和偏移量(Offset)。</li>
<li>线性地址：也通常成为虚拟地址,在32位系统中,它是32位的无符号整型,最大可以达到4G。</li>
<li>物理地址：就是真正物理内存上的地址。</li>
</ul>
<p><img src="/uploads/2016/11/1.png" alt=""><br>三种地址转换图</p>
<p><img src="/uploads/2016/11/2.png" alt=""><br>分段和分页机制</p>
<p><img src="/uploads/2016/11/3.png" alt=""><br>逻辑地址到线性地址图</p>
<p>线性地址到物理地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">会把线性地址分为：10：10：12</span><br><span class="line">每一个线程的PageDirectory的初始地址都不同，保存在CR3寄存器里面。CR3所指定的就是就是PageDirectory的结构地址。</span><br><span class="line">PageDirectory占4k，一个页。每一项占4个字节。</span><br><span class="line">每一个PageTable表项也占4k，一个页。每一项占4个字节。</span><br><span class="line"></span><br><span class="line">以上两个数据结构每个进程是独立的。都分配在3G~4G的内核内存空间。</span><br></pre></td></tr></table></figure>
<p>###内存管理相关算法</p>
<ul>
<li>buddy : 解决空闲页的问题</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在实际应用中，经常需要分配一组连续的页框，而频繁地申请和释放不同大小的连续页框，必然导致在已分配页框的内存块中分散了许多小块的 空闲页框。这样，即使这些页框是空闲的，其他需要分配连续页框的应用也很难得到满足。</span><br><span class="line">为了避免出现这种情况，Linux内核中引入了伙伴系统算法(buddy system)。把所有的空闲页框分组为11个 块链表，每个块链表分别包含大小为1，2，4，8，16，32，64，128，256，512和1024个连续页框的页框块。最大可以申请1024个连 续页框，对应4MB大小的连续内存。每个页框块的第一个页框的物理地址是该块大小的整数倍。</span><br></pre></td></tr></table></figure>
<ul>
<li>slab :    用于解决特定大小缓存浪费块空间的问题。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">工作于物理内存页框分配器之上，管理特定大小对象的缓存，进行快速而高效的内存分配。</span><br><span class="line">slab分配器为每种使用的内核对象建立单独的缓冲区。Linux 内核已经采用了伙伴系统管理物理内存页框，因此 slab分配器直接工作于伙伴系 统之上。每种缓冲区由多个 slab 组成，每个 slab就是一组连续的物理内存页框，被划分成了固定数目的对象。根据对象大小的不同，缺省情况下一个 slab 最多可以由 1024个页框构成。出于对齐 等其它方面的要求，slab 中分配给对象的内存可能大于用户要求的对象实际大小，这会造成一定的 内存浪费。</span><br></pre></td></tr></table></figure>
<p>###内存分配相关函数</p>
<ul>
<li>__get_free_pages</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">　　unsigned long __get_free_pages(gfp_t gfp_mask, unsigned int order)</span><br><span class="line">　　__get_free_pages函数是最原始的内存分配方式，直接从伙伴系统中获取原始页框，返回值为第一个页框的起始地址</span><br></pre></td></tr></table></figure>
<ul>
<li><p>kmem_cache_create/ kmem_cache_alloc是基于slab分配器的一种内存分配方式，适用于反复分配释放同一大小内存块的场合。首先用kmem_cache_create创建一个高速缓存区域，然后用kmem_cache_alloc从 该高速缓存区域中获取新的内存块。</p>
</li>
<li><p>kmalloc</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">　　void *kmalloc(size_t size, gfp_t flags)</span><br><span class="line">　　kmalloc是内核中最常用的一种内存分配方式，它通过调用kmem_cache_alloc函 数来实现。kmalloc一次最多能申请的内存大小由include/linux/Kmalloc_size.h的 内容来决定.</span><br></pre></td></tr></table></figure>
<ul>
<li>vmalloc</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">　　void *vmalloc(unsigned long size)</span><br><span class="line">　　前面几种内存分配方式都是物理连续的，能保证较低的平均访问时间。但是在某些场合</span><br><span class="line">中，对内存区的请求不是很频繁，较高的内存访问时间也 可以接受，这是就可以分配一段线性连续，物理不连续的地址，带来的好处是一次可以分配较大块的内存。vmalloc对 一次能分配的内存大小没有明确限制。出于性能考虑，应谨慎使用vmalloc函数。在测试过程中， 最大能一次分配1GB的空间。</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/09/hadoop-ha-bu-shu-fang-an/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/09/hadoop-ha-bu-shu-fang-an/" itemprop="url">
                  Hadoop HA 部署方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-09T17:18:23+08:00">
                2016-10-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Hadoop HA 部署方案</p>
<ul>
<li>原理</li>
<li>部署方法</li>
</ul>
<p>###原理</p>
<p><img src="/uploads/2016/10/HA.png" alt=""><br>原理图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HA的方案比单节点Master多了几个组件：</span><br><span class="line">zookeeper集群：   主要是用来维护和选举Master</span><br><span class="line">ZKFC:            每一个master上必须运行一个，主要是用来监控master的状态，为选举active的master做状态监控。</span><br><span class="line">JN（JournalNode）集群：  主要是用来存储Master的原始数据，log和Matadata。防止log和matadata丢失。</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">###部署方法</span><br><span class="line">官方连接：https://hadoop.apache.org/docs/r2.6.0/hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithQJM.html#Configuration_details</span><br><span class="line"></span><br><span class="line">主要配置文件:</span><br><span class="line">hdfs-site.xml</span><br></pre></td></tr></table></figure>
<p><configuration><br>        <property><br>          <name>dfs.nameservices</name><br>          <value>pslcluster</value><br>    </property><br>        <property><br>            <name>dfs.ha.namenodes.pslcluster</name><br>          <value>nn1,nn2</value><br>    </property><br>        <property><br>          <name>dfs.namenode.rpc-address.pslcluster.nn1</name><br>          <value>master:8020</value><br>    </property><br>    <property><br>          <name>dfs.namenode.rpc-address.pslcluster.nn2</name><br>          <value>slave4:8020</value><br>    </property><br>    <property><br>          <name>dfs.namenode.http-address.pslcluster.nn1</name><br>          <value>master:50070</value><br>    </property><br>    <property><br>          <name>dfs.namenode.http-address.pslcluster.nn2</name><br>          <value>slave4:50070</value><br>    </property><br>        <property><br>          <name>dfs.namenode.shared.edits.dir</name><br>          <value>qjournal://slave1:8485;slave2:8485;slave3:8485/mycluster</value><br>    </property><br>    <property><br>          <name>dfs.client.failover.proxy.provider.pslcluster</name><br>          <value>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</value><br>    </property><br>    <property><br>          <name>dfs.ha.fencing.methods</name><br>          <value>sshfence</value><br>    </property><br>    <property><br>          <name>dfs.ha.fencing.ssh.private-key-files</name><br>          <value>/home/hadoop/.ssh/id_rsa</value><br>    </property></configuration></p>
<pre><code>&lt;property&gt;
      &lt;name&gt;dfs.journalnode.edits.dir&lt;/name&gt;
      &lt;value&gt;/usr/local/hadoopHA/journal/data&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
       &lt;name&gt;dfs.ha.automatic-failover.enabled&lt;/name&gt;
       &lt;value&gt;true&lt;/value&gt;
 &lt;/property&gt;
</code></pre><p><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">core-site.xml</span><br></pre></td></tr></table></figure></p>
<p><configuration><br>    <property><br>          <name>fs.defaultFS</name><br>          <value>hdfs://pslcluster</value><br>    </property><br>    <property><br>           <name>ha.zookeeper.quorum</name><br>           <value>master:2181,slave1:2181,slave2:2181</value><br>     </property><br>    <property><br>           <name>hadoop.tmp.dir</name><br>           <value>/usr/local/hadoopHA/tmp</value><br>     </property><br></configuration><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">slaves</span><br></pre></td></tr></table></figure></p>
<p>Slave1<br>Slave2<br>Slave3<br>```</p>
<p>还必须配置一下hadoop-env.sh 中的java环境</p>
<p>启动过程：</p>
<ol>
<li><p>首先手动启动journalnode<br>hadoop-daemon.sh start journalnode在相关的</p>
</li>
<li><p>在其中一台namenode上面格式化<br>namenode hdfs namenode -format</p>
</li>
<li><p>启动刚刚格式化完成的namenode :<br>启动一个namenode</p>
</li>
<li><p>在另外一台master上面的copy相关原始数据<br>hdfs namenode -bootstrapStandby</p>
</li>
<li><p>停止所有服务<br>./stop-all.sh</p>
</li>
<li><p>初始化zkfc<br>hdfs zkfc -formatZK</p>
</li>
<li><p>启动集群<br>start-dfs.sh</p>
</li>
</ol>
<p>部署好之后可以看一下相关的进程和端口：<br><a href="http://master:50070" target="_blank" rel="noopener">http://master:50070</a><br>尝试put一个数据到相关的集群。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/08/trident-li-lun-xue-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/08/trident-li-lun-xue-xi/" itemprop="url">
                  Trident 理论学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-08T20:47:44+08:00">
                2016-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Trident 理论学习</p>
<p>###Trident API – Spout<br>ITridentSpout :最通用的Spout,可以支持事务或者不透明事务语义。<br>IBatchSpout : 一个非事务spout。<br>IPartitionedTridentSpout: 分区事务spout，从数据源（eg:Kafka集群）读分区数据。<br>IOpaquePartitionedTridentSpout: 不透明分区事务spout，从数据源读分区数据。</p>
<p>###Trident API  – Bolt<br>唯一显性Bolt接口：ITridentBatchBolt，但很少用。<br>Trident编程特点就是Stream。<br>Trident的topology会被编译成尽可能高效的Storm topology。只有在需要对数据进行repartition的时候（如groupby或者shuffle）才会把tuple通过network发送出去.</p>
<p>###Trident 概念之Operation<br>Operation 类相关概念：</p>
<ul>
<li>Function ， 如BaseFunction, 如TridentWordCount 中用的split、如BaseQueryFunction, TridentWordCount中用的MapGet,从State中查询</li>
<li>Filter : 如BaseFilter， 如TridentWordCount 中用的FilterNull</li>
<li><p>聚合类： </p>
<pre><code>CombinerAggregator&lt;T&gt;
Aggregator&lt;T&gt;
ReducerAggregator&lt;T&gt;
</code></pre><p>Function:</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> public class MyFunction extends BaseFunction &#123;</span><br><span class="line">    public void execute(TridentTuple tuple, TridentCollector collector) &#123;</span><br><span class="line">        for(int i=0; i &lt; tuple.getInteger(0); i++) &#123;</span><br><span class="line">            collector.emit(new Values(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设有一个叫“mystream”输入流有【“a”，“b”，“c”】三个字段<br>【1，2，3】<br>【4，1，6】<br>【3，0，8】<br> 运行mystream.each(new Fields(“b”), new MyFunction(), new Fields(“d”))<br> 运行的结果将会有四个字段【“a”, “b”, “c”, “d”】<br> [1,2,3,0]<br> [1,2,3,1]<br> [4,1,6,0]</p>
<p> Filters:<br> Filters接收一个元组（tuple），决定是否需要继续保留这个元组。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class MyFilter extends BaseFilter&#123;</span><br><span class="line">    public booleanisKeep(TridentTuple tuple) &#123;</span><br><span class="line">        return tuple.getInteger(0) == 1 &amp;&amp; tuple.getInteger(1) == 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假如有如下输入：<br>【1，2，3】<br>【2，1，1】<br>【2，3，4】<br>运行下面的代码：<br>mystream.each(new Fields(“b”, “a”), new MyFilter())<br>结果将会是：<br>【2，1，1】</p>
<p>聚合：<br>例子：persistentAggregate(new MemoryMapState.Factory(), new Count(), new Fields(“count”))   在持久化中使用到。new Count就是具体的聚合类。</p>
<p>聚合接口：<br>CombinerAggreator：在每个tuple上运行init，使用combine去联合结果 。如果批次没有数据，运行zero函数。<br>ReduceAggregator:在init()初始化的时候产生一个值，每个输入的元组在这个值的基础上进行迭代并输出一个单独的值<br>Aggregate：功能最强大</p>
<ol>
<li>Init函数在执行批次操作之前被调用，并返回一个state对象，这个对象将会会传入到aggregate和complete函数中。</li>
<li>Aggregate会对批次中每个tuple调用，这个方法可以跟新state也可以发射（emit）tuple。</li>
<li>当这个批次分区的数据执行结束后调用complete函数。<br>aggregate和persistentAggregate函数对流做聚合。Aggregate在每个批次上独立运行，persistentAggregate聚合流的所有的批次并将结果存储下来。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class Sum implements CombinerAggregator&lt;Number&gt; &#123;</span><br><span class="line">    public Sum() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Number init(TridentTuple tuple) &#123;</span><br><span class="line">        return (Number)tuple.getValue(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Number combine(Number val1, Number val2) &#123;</span><br><span class="line">        return Numbers.add(val1, val2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Number zero() &#123;</span><br><span class="line">        return Integer.valueOf(0);</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/08/stormbu-tou-ming-shi-wu-shi-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/08/stormbu-tou-ming-shi-wu-shi-li/" itemprop="url">
                  Storm不透明事务示例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-08T16:55:37+08:00">
                2016-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm不透明事务示例<br>在IPartitionedTransactionalSpout 案例基础上用IOpaquePartitionedTransactionalSpout 实现<br>实现分析：<br>需调整Spout端 和  Bolt端<br>Bolt端主要是调整写库部分</p>
<p>class DbValue {<br>String dateStr;  // 按日期汇总<br>int count = 0;  // 汇总数<br>BigInteger txid; // 事务ID<br>Int prev_count ; // 上个事务批次处理后的结果<br>}<br>DbValue模拟一个数据表</p>
<p>对于commiter bolt必须要记录上一次事务tuple的个数，因为可能同一个事务重发之后</p>
<ul>
<li>MyOpaquePtTxSpout.java   </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">public class MyOpaquePtTxSpout implements IOpaquePartitionedTransactionalSpout &#123;</span><br><span class="line"></span><br><span class="line">    public static int BATCH_NUM = 10 ;</span><br><span class="line">    public Map&lt;Integer, Map&lt;Long,String&gt;&gt; PT_DATA_MP = new HashMap&lt;Integer, Map&lt;Long,String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    public MyOpaquePtTxSpout()</span><br><span class="line">    &#123;</span><br><span class="line">        Random random = new Random();</span><br><span class="line">        String[] hosts = &#123; &quot;www.taobao.com&quot; &#125;;</span><br><span class="line">        String[] session_id = &#123; &quot;ABYH6Y4V4SCVXTG6DPB4VH9U123&quot;, &quot;XXYH6YCGFJYERTT834R52FDXV9U34&quot;, &quot;BBYH61456FGHHJ7JL89RG5VV9UYU7&quot;,</span><br><span class="line">                &quot;CYYH6Y2345GHI899OFG4V9U567&quot;, &quot;VVVYH6Y4V4SFXZ56JIPDPB4V678&quot; &#125;;</span><br><span class="line">        String[] time = &#123; &quot;2014-01-07 08:40:50&quot;, &quot;2014-01-07 08:40:51&quot;, &quot;2014-01-07 08:40:52&quot;, &quot;2014-01-07 08:40:53&quot;,</span><br><span class="line">                &quot;2014-01-07 09:40:49&quot;, &quot;2014-01-07 10:40:49&quot;, &quot;2014-01-07 11:40:49&quot;, &quot;2014-01-07 12:40:49&quot; &#125;;</span><br><span class="line"></span><br><span class="line">        for (int j = 0; j &lt; 5; j++) &#123;</span><br><span class="line">            HashMap&lt;Long, String&gt; dbMap = new HashMap&lt;Long, String&gt; ();</span><br><span class="line">            for (long i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                dbMap.put(i,hosts[0]+&quot;\t&quot;+session_id[random.nextInt(5)]+&quot;\t&quot;+time[random.nextInt(8)]);</span><br><span class="line">            &#125;</span><br><span class="line">            PT_DATA_MP.put(j, dbMap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public Emitter getEmitter(Map map, TopologyContext topologyContext) &#123;</span><br><span class="line">        return new MyEmiiter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Coordinator getCoordinator(Map map, TopologyContext topologyContext) &#123;</span><br><span class="line">        return new MyCoordinator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Object&gt; getComponentConfiguration() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class MyCoordinator implements IOpaquePartitionedTransactionalSpout.Coordinator&#123;</span><br><span class="line"></span><br><span class="line">        public boolean isReady() &#123;</span><br><span class="line">            Utils.sleep(2000);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void close() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class MyEmiiter implements IOpaquePartitionedTransactionalSpout.Emitter&lt;MyMata&gt;&#123;</span><br><span class="line"></span><br><span class="line">        public MyMata emitPartitionBatch(TransactionAttempt transactionAttempt,</span><br><span class="line">                                         BatchOutputCollector batchOutputCollector, int partition, MyMata myMata) &#123;</span><br><span class="line">            // TODO Auto-generated method stub</span><br><span class="line">            System.err.println(&quot;emitPartitionBatch partition:&quot;+partition);</span><br><span class="line">            long beginPoint = 0;</span><br><span class="line">            if (myMata == null) &#123;</span><br><span class="line">                beginPoint = 0 ;</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                beginPoint = myMata.getBeginPoint() + myMata.getNum() ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MyMata mata = new MyMata() ;</span><br><span class="line">            mata.setBeginPoint(beginPoint);</span><br><span class="line">            mata.setNum(BATCH_NUM);</span><br><span class="line">            System.err.println(&quot;启动一个事务：&quot;+mata.toString());</span><br><span class="line"></span><br><span class="line">            Map&lt;Long, String&gt; batchMap = PT_DATA_MP.get(partition);</span><br><span class="line">            for (Long i = mata.getBeginPoint(); i &lt; mata.getBeginPoint()+mata.getNum(); i++) &#123;</span><br><span class="line">                if (batchMap.size()&lt;=i) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                batchOutputCollector.emit(new Values(transactionAttempt, batchMap.get(i)));</span><br><span class="line">            &#125;</span><br><span class="line">            return mata;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int numPartitions() &#123;</span><br><span class="line">            return 5;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void close() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/08/stormfen-qu-shi-wu-shi-li-cheng-xu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/08/stormfen-qu-shi-wu-shi-li-cheng-xu/" itemprop="url">
                  Storm分区事务示例程序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-08T15:49:40+08:00">
                2016-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm分区事务示例程序</p>
<p>分区事务和事务相关代码的区别主要在于spout端的代码</p>
<ul>
<li>MyPtTxSpout.java   //分区事务的spout端代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">public Map&lt;Integer, Map&lt;Long,String&gt;&gt; PT_DATA_MP = new HashMap&lt;Integer, Map&lt;Long,String&gt;&gt;();</span><br><span class="line">    public static int BATCH_NUM = 10 ;</span><br><span class="line"></span><br><span class="line">    public MyPtTxSpout()</span><br><span class="line">    &#123;</span><br><span class="line">        Random random = new Random();</span><br><span class="line">        String[] hosts = &#123; &quot;www.taobao.com&quot; &#125;;</span><br><span class="line">        String[] session_id = &#123; &quot;ABYH6Y4V4SCVXTG6DPB4VH9U123&quot;, &quot;XXYH6YCGFJYERTT834R52FDXV9U34&quot;, &quot;BBYH61456FGHHJ7JL89RG5VV9UYU7&quot;,</span><br><span class="line">                &quot;CYYH6Y2345GHI899OFG4V9U567&quot;, &quot;VVVYH6Y4V4SFXZ56JIPDPB4V678&quot; &#125;;</span><br><span class="line">        String[] time = &#123; &quot;2014-01-07 08:40:50&quot;, &quot;2014-01-07 08:40:51&quot;, &quot;2014-01-07 08:40:52&quot;, &quot;2014-01-07 08:40:53&quot;,</span><br><span class="line">                &quot;2014-01-07 09:40:49&quot;, &quot;2014-01-07 10:40:49&quot;, &quot;2014-01-07 11:40:49&quot;, &quot;2014-01-07 12:40:49&quot; &#125;;</span><br><span class="line"></span><br><span class="line">        for (int j = 0; j &lt; 5; j++) &#123;</span><br><span class="line">            HashMap&lt;Long, String&gt; dbMap = new HashMap&lt;Long, String&gt; ();</span><br><span class="line">            for (long i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                dbMap.put(i,hosts[0]+&quot;\t&quot;+session_id[random.nextInt(5)]+&quot;\t&quot;+time[random.nextInt(8)]);</span><br><span class="line">            &#125;</span><br><span class="line">            PT_DATA_MP.put(j, dbMap);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Coordinator getCoordinator(Map map, TopologyContext topologyContext) &#123;</span><br><span class="line">        return new MyCoordinator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Emitter&lt;MyMata&gt; getEmitter(Map map, TopologyContext topologyContext) &#123;</span><br><span class="line">        return new MyEmitter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;tx&quot;, &quot;log&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Object&gt; getComponentConfiguration() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class MyCoordinator implements  IPartitionedTransactionalSpout.Coordinator&#123;</span><br><span class="line"></span><br><span class="line">        public int numPartitions() &#123;</span><br><span class="line">            ///返回有几个分区</span><br><span class="line">            return 5;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public boolean isReady() &#123;</span><br><span class="line">            Utils.sleep(2000);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void close() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class MyEmitter implements IPartitionedTransactionalSpout.Emitter&lt;MyMata&gt;&#123;</span><br><span class="line"></span><br><span class="line">        public MyMata emitPartitionBatchNew(TransactionAttempt transactionAttempt,</span><br><span class="line">                                            BatchOutputCollector batchOutputCollector, int partition, MyMata myMata) &#123;</span><br><span class="line">            ///新的事务调用的发送函数</span><br><span class="line">            //此函数可以和非分区的事务代码中 Coordinator做对比   基本差不多</span><br><span class="line">            long beginPoint = 0;</span><br><span class="line">            if(myMata == null)&#123;</span><br><span class="line">                beginPoint = 0;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                beginPoint = myMata.getBeginPoint() + myMata.getNum();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MyMata myMata1 = new MyMata();</span><br><span class="line">            myMata1.setNum(BATCH_NUM);</span><br><span class="line">            myMata1.setBeginPoint(beginPoint);</span><br><span class="line"></span><br><span class="line">            //启动一个事务</span><br><span class="line">            emitPartitionBatch(transactionAttempt, batchOutputCollector, partition, myMata1);</span><br><span class="line"></span><br><span class="line">            return myMata1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void emitPartitionBatch(TransactionAttempt transactionAttempt,</span><br><span class="line">                                       BatchOutputCollector batchOutputCollector, int partition, MyMata myMata) &#123;</span><br><span class="line">            //失败的事务调用的函数</span><br><span class="line">            long beginPoint = myMata.getBeginPoint() ;</span><br><span class="line">            int num = myMata.getNum() ;</span><br><span class="line"></span><br><span class="line">            Map&lt;Long, String&gt; batchMap = PT_DATA_MP.get(partition);</span><br><span class="line">            for (long i = beginPoint; i &lt; num+beginPoint; i++) &#123;</span><br><span class="line">                if (batchMap.get(i)==null) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                batchOutputCollector.emit(new Values(transactionAttempt,batchMap.get(i)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void close() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/08/stormshi-wu-shi-li-cheng-xu-fen-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/08/stormshi-wu-shi-li-cheng-xu-fen-xi/" itemprop="url">
                  Storm事务示例程序分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-08T14:18:57+08:00">
                2016-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm事务示例程序分析</p>
<ul>
<li>MyMata.java 原始数据类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class MyMata implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">    private long beginPoint; // 事务开始位置</span><br><span class="line">    private int num;</span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;beginPoint : &quot; + getBeginPoint() + &quot;---- len : &quot; + getNum();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setBeginPoint(long beginPoint) &#123;</span><br><span class="line">        this.beginPoint = beginPoint;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setNum(int num) &#123;</span><br><span class="line">        this.num = num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public long getBeginPoint() &#123;</span><br><span class="line">        return beginPoint;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getNum() &#123;</span><br><span class="line">        return num;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyTxSpout.java  spout类，产生原始数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class MyTxSpout implements ITransactionalSpout&lt;MyMata&gt; &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;Long, String&gt; dbMap = null;</span><br><span class="line">    //private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">    public MyTxSpout()&#123;</span><br><span class="line">        Random random = new Random();</span><br><span class="line"></span><br><span class="line">        dbMap = new HashMap&lt;Long, String&gt;();</span><br><span class="line"></span><br><span class="line">        String[] hosts = &#123; &quot;www.taobao.com&quot; &#125;;</span><br><span class="line">        String[] session_id = &#123; &quot;ABYH6Y4V4SCVXTG6DPB4VH9U123&quot;, &quot;XXYH6YCGFJYERTT834R52FDXV9U34&quot;, &quot;BBYH61456FGHHJ7JL89RG5VV9UYU7&quot;,</span><br><span class="line">                &quot;CYYH6Y2345GHI899OFG4V9U567&quot;, &quot;VVVYH6Y4V4SFXZ56JIPDPB4V678&quot; &#125;;</span><br><span class="line">        String[] time = &#123; &quot;2014-01-07 08:40:50&quot;, &quot;2014-01-07 08:40:51&quot;, &quot;2014-01-07 08:40:52&quot;, &quot;2014-01-07 08:40:53&quot;,</span><br><span class="line">                &quot;2014-01-07 09:40:49&quot;, &quot;2014-01-07 10:40:49&quot;, &quot;2014-01-07 11:40:49&quot;, &quot;2014-01-07 12:40:49&quot; &#125;;</span><br><span class="line"></span><br><span class="line">        for (long i = 0; i &lt; 100; i++)</span><br><span class="line">            dbMap.put(i, hosts[0] + &quot;\t&quot; + session_id[random.nextInt(5)] + &quot;\t&quot; + time[random.nextInt(8)]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Coordinator&lt;MyMata&gt; getCoordinator(Map map, TopologyContext topologyContext) &#123;</span><br><span class="line"></span><br><span class="line">        return new MyCoordinator(); ///用于发送和保存事务相关信息</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Emitter&lt;MyMata&gt; getEmitter(Map map, TopologyContext topologyContext) &#123;</span><br><span class="line">        return new MyEmitter(dbMap);//用于发送每一个事务具体的数据</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;tx&quot;, &quot;log&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Object&gt; getComponentConfiguration() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyCoordinator.java   //用于为每一次事务设定原始数据，并启动事务</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class MyCoordinator implements ITransactionalSpout.Coordinator&lt;MyMata&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private static int BATCH_NUM = 10;</span><br><span class="line"></span><br><span class="line">    public MyMata initializeTransaction(BigInteger bigInteger, MyMata preMyMata) &#123;</span><br><span class="line"></span><br><span class="line">        long beginPoint = 0;</span><br><span class="line">        if (preMyMata == null)&#123;</span><br><span class="line">            beginPoint = 0;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            beginPoint = preMyMata.getBeginPoint() + preMyMata.getNum();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MyMata nowMyMata = new MyMata();</span><br><span class="line">        nowMyMata.setBeginPoint(beginPoint);</span><br><span class="line">        nowMyMata.setNum(BATCH_NUM);</span><br><span class="line">        System.err.println(&quot;MyCoordinator initializeTransaction 启动一个事务: &quot; + nowMyMata.toString());</span><br><span class="line"></span><br><span class="line">        return nowMyMata;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isReady() &#123;</span><br><span class="line">        Utils.sleep(2000);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void close() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyEmitter.java   //获取Coordinator里面设定的原始数据，并根据相关类容发送相关tuple</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public class MyEmitter implements ITransactionalSpout.Emitter&lt;MyMata&gt; &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;Long, String&gt; dbMap = null;</span><br><span class="line"></span><br><span class="line">    public MyEmitter(Map&lt;Long, String&gt; dbMap)&#123;</span><br><span class="line">        this.dbMap = dbMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void emitBatch(TransactionAttempt transactionAttempt, MyMata myMata, BatchOutputCollector batchOutputCollector) &#123;</span><br><span class="line">        long beginPoint = myMata.getBeginPoint();</span><br><span class="line">        int num = myMata.getNum();</span><br><span class="line"></span><br><span class="line">        for(long i = beginPoint; i &lt; beginPoint + num; i++)&#123;</span><br><span class="line">            if (dbMap.get(i) == null)&#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            batchOutputCollector.emit(new Values(transactionAttempt, dbMap.get(i)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void cleanupBefore(BigInteger bigInteger) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void close() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyTransactionalBolt.java //一级bolt。写代码的时候注意，每一次batch事务过来后，都会重新生成新德MyTransactionalBolt类。类里面相关的临时数据会全部消失。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class MyTransactionalBolt extends BaseTransactionalBolt &#123;</span><br><span class="line"></span><br><span class="line">    private TransactionAttempt tx = null;</span><br><span class="line">    private BatchOutputCollector batchOutputCollector = null;</span><br><span class="line">    //private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">    int count = 0;</span><br><span class="line"></span><br><span class="line">///一次批处理事务会调用一次</span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, BatchOutputCollector batchOutputCollector,</span><br><span class="line">                        TransactionAttempt transactionAttempt) &#123;</span><br><span class="line">        this.tx = transactionAttempt;</span><br><span class="line">        this.batchOutputCollector = batchOutputCollector;</span><br><span class="line"></span><br><span class="line">        System.err.println(&quot;MyTransactionalBolt prepare  TransactionId: &quot; + transactionAttempt.getTransactionId() +</span><br><span class="line">                &quot;---- AttemptId:&quot; + transactionAttempt.getAttemptId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">////对每一个tuple都会调用一次</span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line"></span><br><span class="line">        TransactionAttempt txExe = (TransactionAttempt)tuple.getValueByField(&quot;tx&quot;);</span><br><span class="line"></span><br><span class="line">        System.err.println(&quot;MyTransactionalBolt execute  TransactionId: &quot; + txExe.getTransactionId() +</span><br><span class="line">                &quot;---- AttemptId:&quot; + txExe.getAttemptId());</span><br><span class="line"></span><br><span class="line">        String log = tuple.getStringByField(&quot;log&quot;);</span><br><span class="line"></span><br><span class="line">        if (log != null &amp;&amp; log.length() &gt; 0)&#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">////一次批处理事务会调用一次</span><br><span class="line">    public void finishBatch() &#123;</span><br><span class="line">        System.err.println(&quot;MyTransactionalBolt finishBatch : &quot; + count);</span><br><span class="line">        this.batchOutputCollector.emit(new Values(tx, count));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;tx&quot;, &quot;count&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyCommitter.java   //批处理会按照事务的顺序进行committer</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public class MyCommitter extends BaseTransactionalBolt implements ICommitter &#123;</span><br><span class="line"></span><br><span class="line">    //private static final long serialVersionUID = 1L;</span><br><span class="line"></span><br><span class="line">    int sum = 0;</span><br><span class="line">    TransactionAttempt tx = null;</span><br><span class="line">    BatchOutputCollector batchOutputCollector = null;</span><br><span class="line"></span><br><span class="line">    public static final String GLOBAL_KEY = &quot;GLOBAL_KEY&quot;;</span><br><span class="line">    ///这里是静态的，不管来多少次事务，里面的相关数据都会保存。</span><br><span class="line">    public static Map&lt;String, DbValue&gt; dbMap = new HashMap&lt;String, DbValue&gt;() ;</span><br><span class="line">    //public Map&lt;String, DbValue&gt; dbMap = new HashMap&lt;String, DbValue&gt;() ;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, BatchOutputCollector batchOutputCollector,</span><br><span class="line">                        TransactionAttempt transactionAttempt) &#123;</span><br><span class="line">        this.tx = transactionAttempt;</span><br><span class="line">        this.batchOutputCollector = batchOutputCollector;</span><br><span class="line"></span><br><span class="line">        System.err.println(&quot;MyCommitter prepare : &quot; + tx.getTransactionId() + &quot; : &quot; + tx.getAttemptId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        sum += tuple.getInteger(1);</span><br><span class="line">        System.err.println(&quot;MyCommitter execute : &quot; + tx.getTransactionId() + &quot; : &quot; + tx.getAttemptId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">////事务处理完成后，会按照顺序来进行提交</span><br><span class="line">    public void finishBatch() &#123;</span><br><span class="line">        System.err.println(&quot;MyCommitter finishBatch : &quot; + tx.getTransactionId() + &quot; : &quot; + tx.getAttemptId());</span><br><span class="line">        DbValue value = dbMap.get(GLOBAL_KEY);</span><br><span class="line">        DbValue newValue;</span><br><span class="line"></span><br><span class="line">        if (value == null || !value.txid.equals(tx.getTransactionId()))&#123;</span><br><span class="line">            newValue = new DbValue();</span><br><span class="line">            newValue.txid = tx.getTransactionId();</span><br><span class="line">            if (value == null)&#123;</span><br><span class="line">                newValue.count = sum;</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">                newValue.count = sum + value.count;</span><br><span class="line">            &#125;</span><br><span class="line">            dbMap.put(GLOBAL_KEY, newValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;total==========================:&quot;+dbMap.get(GLOBAL_KEY).count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class DbValue&#123;</span><br><span class="line">        BigInteger txid;</span><br><span class="line">        int count = 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>MyTopo.java   ///事务top的相关编写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class MyTopo &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String [] args)&#123;</span><br><span class="line">        TransactionalTopologyBuilder builder = new TransactionalTopologyBuilder(&quot;ttbId&quot;,&quot;spoutid&quot;,new MyTxSpout(),1);</span><br><span class="line">        builder.setBolt(&quot;bolt1&quot;, new MyTransactionalBolt(),3).shuffleGrouping(&quot;spoutid&quot;);</span><br><span class="line">        builder.setBolt(&quot;committer&quot;, new MyCommitter(),1).shuffleGrouping(&quot;bolt1&quot;) ;</span><br><span class="line"></span><br><span class="line">        Config conf = new Config() ;</span><br><span class="line">        conf.setDebug(true);</span><br><span class="line"></span><br><span class="line">        if (args.length &gt; 0) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                StormSubmitter.submitTopology(args[0], conf, builder.buildTopology());</span><br><span class="line">            &#125; catch (AlreadyAliveException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (InvalidTopologyException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; catch (AuthorizationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            LocalCluster localCluster = new LocalCluster();</span><br><span class="line">            localCluster.submitTopology(&quot;mytopology&quot;, conf, builder.buildTopology());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/08/stormshi-wu-pi-chu-li-yuan-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/08/stormshi-wu-pi-chu-li-yuan-li/" itemprop="url">
                  Storm事务-批处理原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-08T13:54:36+08:00">
                2016-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm事务-批处理原理</p>
<ol>
<li><p>事务<br>对于容错机制，Storm通过一个系统级别的组件acker，判断tuple是否发送成功，进而spout可以重发该tuple，保证一个tuple在出错的情况下至少被重发一次。<br>但是在需要精确统计tuple的场景下（销售金额），希望每个tuple“被且仅被处理一次”。storm引入了Transactional Topology。它可以保证每一个“tuple”被且仅被处理一次，这样就可以实现一种非常准确，且高度容错方式来实现计数类应用。</p>
</li>
<li><p>批处理<br>逐个处理单个tuple，增加很多开销，如写库、输出结果频率过高。事务处理单个tuple效率比较低，因此storm中引入batch处理。<br>批处理是一次性处理一批（batch）tuple，事务可以确保该批次要么全部处理成功，如果有处理失败的则全部不计，Storm会对失败的批次重新发送，且确保每一个batch被且仅被处理一次。</p>
</li>
</ol>
<p>###事务机制和原理<br>对于只处理一次的需要，从原理上来讲，需要在发送tuple的时候带上，txid，在需要事务处理的时候，根据该txid是否以前已经处理成功来决定是否进行处理，当然需要把txid和处理结果一起做保存。<br>在事务batch处理中，一批tuple赋予一个txid，为了提高batch之间处理的并行度，storm采用了pipeline处理模型，这样多个事务可以并行执行，但是commit的是严格按照顺序的。</p>
<p>Storm事务处理中，把一个batch的计算分成两个阶段processing和commit阶段：<br>processing阶段：多个batch可以并行计算。<br>commit阶段：batch之间强制按照顺序进行提交。<br><img src="/uploads/2016/10/--1.png" alt=""></p>
<p>####事务Topologies<br>使用Transactional Topologies的时候，storm为你做下面这些事情。</p>
<ul>
<li>管理状态：Storm把所有实现Transactional Topologies所必须的状态保存在zookeeper里面，包括当前transaction id 以及定义每一个batch的一些元数据。</li>
<li>协调事务：Storm帮你管理所有事情，如帮你决定在任何一个时间点是该processing还是该committing.</li>
<li>错误检测: Storm利用acking框架来高效地检测什么时候一个batch被成功处理了，被成功提交了，或者失败了。Storm然后会相应地replay对应的batch。你不需要自己手    动做任何acking或者anchoring (emit时发生的动作)。</li>
<li>内置的批处理API: Storm在普通bolt之上包装了一层API来提供对tuple的批处理支持。Storm管理所有的协调工作，包括决定什么时候一个bolt接收到一个特定transaction的所有tuple。Storm同时也会自动清理每个transaction所产生的中间数据。</li>
</ul>
<p>事务性的spout需要实现ITransactionalSpout，这个接口包含两个内部接口类Coordinator和Emitter。在topology运行的时候，事务性的spout内部包含一个子Topology，结构图如下：</p>
<p><img src="/uploads/2016/10/--2.png" alt=""></p>
<p>这里面有两种类型的tuple，一种是事务性的tuple，一种是batch中的tuple；<br>coordinator 开启一个事务准备发射一个batch时候，进入一个事务的processing阶段，会发射一个事务性 tuple(transactionAttempt &amp; metadata)到”batch emit”流</p>
<p>Emitter以all grouping(广播)的方式订阅coordinator的”batch emit”流，负责为每个batch实际发射tuple。发送的tuple都必须以TransactionAttempt作为第一个field，storm根据这个field来判断tuple属于哪一个batch。</p>
<p>coordinator只有一个，emitter根据并行度可以有多个实例</p>
<p>coordinator只有一个，emitter根据并行度可以有多个实例</p>
<p>####TransactionAttempt 和 元数据</p>
<p>TransactionAttempt包含两个值：一个transaction id，一个attempt id。transaction id的作用就是我们上面介绍的对于每个batch中的tuple是唯一的，而且不管这个batch    replay多少次都是一样的。<br>attempt id是对于每个batch唯一的一个id， 但是对于同一个batch，它replay之后的attempt id跟replay之前就不一样了，<br>我们可以把attempt id理解成replay-times， storm利用这个id来区别一个batch发射的tuple的不同版本</p>
<p>metadata(元数据)中包含当前事务可以从哪个point进行重放数据，存放在zookeeper中的，spout可以通过Kryo从zookeeper中序列化和反序列化该元数据。</p>
<p><img src="/uploads/2016/10/--3.png" alt=""><br>内部处理流程</p>
<p>####事务性Bolt</p>
<ul>
<li>BaseTransactionalBolt处理batch在一起的tuples，对于每一个tuple调用调用execute方 法，而在整个batch处理(processing)完成的时候调用finishBatch方法。如果BatchBolt被标记成Committer，则 只能在commit阶段调用finishBatch方法。一个batch的commit阶段由storm保证只在前一个batch成功提交之后才会执行。并且它会重试直到topology里面的所有bolt在commit完成提交。那么如何知道batch的processing完成了，也就是bolt是否接收处理了batch里面所有的tuple；在bolt内部，有一个 CoordinatedBolt的模型。<br>CoordinateBolt具体原理如下：</li>
</ul>
<p><img src="/uploads/2016/10/--4.png" alt=""></p>
<p>每个CoordinateBolt记录两个值：有哪些task给我发送了tuple（根据topology的grouping信息）；我要给哪些task发送信息（同样根据groping信息）。</p>
<p>等所有的tuple都发送完了之后，CoordinateBolt通过另外一个特殊的stream以emitDirect的方式告诉所有它发送过 tuple的task，它发送了多少tuple给这个task。下游task会将这个数字和自己已经接收到的tuple数量做对比，如果相等，则说明处理 完了所有的tuple。</p>
<p>下游CoordinateBolt会重复上面的步骤，通知其下游。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/07/stormke-kao-xing-chu-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/07/stormke-kao-xing-chu-li/" itemprop="url">
                  Storm可靠性处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-07T00:56:31+08:00">
                2016-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm可靠性处理</p>
<ul>
<li>spout可靠性处理</li>
<li>bolt可靠性处理</li>
</ul>
<p>###spout可靠性处理<br>以单词计算的例子为例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.IRichBolt;</span><br><span class="line">import org.apache.storm.topology.IRichSpout;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line">import org.apache.storm.utils.Utils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.UUID;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SentenceSpout extends BaseRichSpout &#123;</span><br><span class="line"></span><br><span class="line">    private SpoutOutputCollector spoutOutputCollector = null;</span><br><span class="line">    private ConcurrentHashMap&lt;UUID, Values&gt; pending;</span><br><span class="line"></span><br><span class="line">    private String [] sentence = &#123;</span><br><span class="line">        &quot;my dog has fleas&quot;,</span><br><span class="line">            &quot;I like cold beverages&quot;,</span><br><span class="line">            &quot;the dog ate my homework&quot;,</span><br><span class="line">            &quot;don&apos;t have a cow man&quot;,</span><br><span class="line">            &quot;i don&apos;t think i like fleas&quot;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    private  int index = 0;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;sentence&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void open(Map map, TopologyContext topologyContext, SpoutOutputCollector spoutOutputCollector) &#123;</span><br><span class="line">        this.spoutOutputCollector = spoutOutputCollector;</span><br><span class="line">        this.pending = new ConcurrentHashMap&lt;UUID, Values&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void nextTuple() &#123;</span><br><span class="line">        UUID msgId = UUID.randomUUID();</span><br><span class="line">        ///发送时必须带上msgId</span><br><span class="line">        this.spoutOutputCollector.emit(new Values(sentence[index]), msgId);</span><br><span class="line"></span><br><span class="line">        this.pending.put(msgId, new Values(sentence[index]));</span><br><span class="line"></span><br><span class="line">        index++;</span><br><span class="line">        if(index &gt;= sentence.length)&#123;</span><br><span class="line">            index = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void ack(Object msgId) &#123;</span><br><span class="line">        System.err.println(&quot;spout ack&quot;);</span><br><span class="line">        this.pending.remove(msgId);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void fail(Object msgId) &#123;</span><br><span class="line">        this.spoutOutputCollector.emit(this.pending.get(msgId), msgId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###bolt可靠性处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SplitSentenceBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private OutputCollector outputCollector = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.outputCollector = outputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String sentence = tuple.getStringByField(&quot;sentence&quot;);</span><br><span class="line">        String [] words = sentence.split(&quot; &quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;splitSentence : &quot; + sentence);</span><br><span class="line"></span><br><span class="line">        for (String word : words)&#123;</span><br><span class="line">            //发送时必须带上 tuple</span><br><span class="line">            this.outputCollector.emit(tuple, new Values(word));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.outputCollector.ack(tuple);</span><br><span class="line">        System.err.println(&quot;split ack&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;word&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面接着的bolt必须全部都加上tuple向后发送，并且处理完成后，显示的调用ack方法。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/07/stormdan-ci-ji-shu-shi-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/07/stormdan-ci-ji-shu-shi-li/" itemprop="url">
                  Storm单词计数示例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-07T00:30:43+08:00">
                2016-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm单词计数示例</p>
<ul>
<li>top代码</li>
<li>spout代码</li>
<li>bolt代码</li>
<li>遇到的bug</li>
</ul>
<p>###top代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.Config;</span><br><span class="line">import org.apache.storm.LocalCluster;</span><br><span class="line">import org.apache.storm.StormSubmitter;</span><br><span class="line">import org.apache.storm.generated.AlreadyAliveException;</span><br><span class="line">import org.apache.storm.generated.AuthorizationException;</span><br><span class="line">import org.apache.storm.generated.InvalidTopologyException;</span><br><span class="line">import org.apache.storm.topology.TopologyBuilder;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.utils.Utils;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/6/16.</span><br><span class="line"> */</span><br><span class="line">public class WordCountTopology &#123;</span><br><span class="line"></span><br><span class="line">    private static final String SENTENCE_SPOUT_ID = &quot;sentence-spout&quot;;</span><br><span class="line">    private static final String SPLIT_BOLT_ID = &quot;split-bolt&quot;;</span><br><span class="line">    private static final String COUNT_BOLT_ID = &quot;count-bolt&quot;;</span><br><span class="line">    private static final String REPORT_BOLT_ID = &quot;report-bolt&quot;;</span><br><span class="line">    private static final String TOPOLOGY_NAME = &quot;word-count-topology&quot;;</span><br><span class="line"></span><br><span class="line">    public static void main(String [] args) throws InvalidTopologyException, AuthorizationException, AlreadyAliveException &#123;</span><br><span class="line">        SentenceSpout sentenceSpout = new SentenceSpout();</span><br><span class="line">        SplitSentenceBolt splitSentenceBolt = new SplitSentenceBolt();</span><br><span class="line">        WordCountBolt wordCountBolt = new WordCountBolt();</span><br><span class="line">        ReportBolt reportBolt = new ReportBolt();</span><br><span class="line"></span><br><span class="line">        TopologyBuilder builder = new TopologyBuilder();</span><br><span class="line"></span><br><span class="line">        builder.setSpout(SENTENCE_SPOUT_ID, sentenceSpout);//, 2);</span><br><span class="line"></span><br><span class="line">        builder.setBolt(SPLIT_BOLT_ID, splitSentenceBolt, 2).setNumTasks(4).shuffleGrouping(SENTENCE_SPOUT_ID);</span><br><span class="line">        //builder.setBolt(SPLIT_BOLT_ID, splitSentenceBolt).shuffleGrouping(SENTENCE_SPOUT_ID);</span><br><span class="line"></span><br><span class="line">        builder.setBolt(COUNT_BOLT_ID, wordCountBolt, 6).fieldsGrouping(SPLIT_BOLT_ID, new Fields(&quot;word&quot;));</span><br><span class="line">        //builder.setBolt(COUNT_BOLT_ID, wordCountBolt).fieldsGrouping(SPLIT_BOLT_ID, new Fields(&quot;word&quot;));</span><br><span class="line"></span><br><span class="line">        builder.setBolt(REPORT_BOLT_ID, reportBolt).globalGrouping(COUNT_BOLT_ID);</span><br><span class="line"></span><br><span class="line">        Config config = new Config();</span><br><span class="line">        //config.setNumWorkers(2);</span><br><span class="line"></span><br><span class="line">        if (args.length == 0) &#123;</span><br><span class="line"></span><br><span class="line">            LocalCluster cluster = new LocalCluster();</span><br><span class="line"></span><br><span class="line">            cluster.submitTopology(TOPOLOGY_NAME, config, builder.createTopology());</span><br><span class="line">            //StormSubmitter.submitTopology(TOPOLOGY_NAME, config, builder.createTopology());</span><br><span class="line"></span><br><span class="line">            Utils.sleep(20000);</span><br><span class="line"></span><br><span class="line">            cluster.killTopology(TOPOLOGY_NAME);</span><br><span class="line"></span><br><span class="line">            cluster.shutdown();</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            StormSubmitter.submitTopology(args[0], config, builder.createTopology());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###spout代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.IRichBolt;</span><br><span class="line">import org.apache.storm.topology.IRichSpout;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line">import org.apache.storm.utils.Utils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SentenceSpout extends BaseRichSpout &#123;</span><br><span class="line"></span><br><span class="line">    private SpoutOutputCollector spoutOutputCollector = null;</span><br><span class="line"></span><br><span class="line">    private String [] sentence = &#123;</span><br><span class="line">        &quot;my dog has fleas&quot;,</span><br><span class="line">            &quot;I like cold beverages&quot;,</span><br><span class="line">            &quot;the dog ate my homework&quot;,</span><br><span class="line">            &quot;don&apos;t have a cow man&quot;,</span><br><span class="line">            &quot;i don&apos;t think i like fleas&quot;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    private  int index = 0;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;sentence&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void open(Map map, TopologyContext topologyContext, SpoutOutputCollector spoutOutputCollector) &#123;</span><br><span class="line">        this.spoutOutputCollector = spoutOutputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void nextTuple() &#123;</span><br><span class="line">        this.spoutOutputCollector.emit(new Values(sentence[index]));</span><br><span class="line"></span><br><span class="line">        index++;</span><br><span class="line">        if(index &gt;= sentence.length)&#123;</span><br><span class="line">            index = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###bolt代码<br>splitSentenceBolt.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SplitSentenceBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private OutputCollector outputCollector = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.outputCollector = outputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String sentence = tuple.getStringByField(&quot;sentence&quot;);</span><br><span class="line">        String [] words = sentence.split(&quot; &quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;splitSentence : &quot; + sentence);</span><br><span class="line"></span><br><span class="line">        for (String word : words)&#123;</span><br><span class="line">            this.outputCollector.emit(new Values(word));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;word&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WordCountBolt.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class WordCountBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private OutputCollector outputCollector = null;</span><br><span class="line">    private HashMap&lt;String, Long&gt; counts = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.outputCollector = outputCollector;</span><br><span class="line">        this.counts = new HashMap&lt;String, Long&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String word = tuple.getStringByField(&quot;word&quot;);</span><br><span class="line">        Long count = this.counts.get(word);</span><br><span class="line">        if(count == null)&#123;</span><br><span class="line">            count = 0L;</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">        this.counts.put(word, count);</span><br><span class="line">        this.outputCollector.emit(new Values(word, count));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;word&quot;, &quot;count&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReportBolt.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line"></span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class ReportBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private HashMap&lt;String, Long&gt; counts = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.counts = new HashMap&lt;String, Long&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String word = tuple.getStringByField(&quot;word&quot;);</span><br><span class="line">        Long count = tuple.getLongByField(&quot;count&quot;);</span><br><span class="line"></span><br><span class="line">        this.counts.put(word, count);</span><br><span class="line"></span><br><span class="line">        //this.cleanup();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        //last bolt</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void cleanup()&#123;</span><br><span class="line">        System.out.println(&quot;----------- FINAL COUNTS -----------&quot;);</span><br><span class="line">        List&lt;String&gt; keys = new ArrayList&lt;String&gt;();</span><br><span class="line">        keys.addAll(this.counts.keySet());</span><br><span class="line"></span><br><span class="line">        Collections.sort(keys);</span><br><span class="line"></span><br><span class="line">        for (String key : keys)&#123;</span><br><span class="line">            System.out.println(key + &quot; : &quot; + this.counts.get(key));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;-----------------------------------&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###遇到的bug<br>我的代码是通过IDEA打包的。相关maven配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br></pre></td></tr></table></figure>
<pre><code>&lt;groupId&gt;org.pslland&lt;/groupId&gt;
&lt;artifactId&gt;stormWC&lt;/artifactId&gt;
&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.storm&lt;/groupId&gt;
        &lt;artifactId&gt;storm-core&lt;/artifactId&gt;
        &lt;version&gt;1.0.2&lt;/version&gt;
        &lt;!--&lt;scope&gt;provided&lt;/scope&gt;--&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre><p></p>
<p></p>
<p>本地调试的时候去掉<scope>provided</scope>标签。</p>
<p>在集群提交测试的时候如果编译没有加上provided 标签会产生如下错误：<br>Caused by: java.io.IOException: Found multiple defaults.yaml resources. </p>
<p>集群提交命令：<br>./storm  jar 包名  类名  参数</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/07/stormfen-zu-fang-shi-he-bing-fa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/07/stormfen-zu-fang-shi-he-bing-fa/" itemprop="url">
                  Storm分组方式和并发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-07T00:16:54+08:00">
                2016-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm分组方式和并发</p>
<ul>
<li>基础理论</li>
<li>Storm分组方式</li>
<li>Storm并发</li>
</ul>
<p>###基础理论</p>
<ul>
<li><p>Nodes(服务器):指配置在一个Storm集群中的服务器，会执行top的一部分运算。一个Storm集群可以包括一个或者多个工作node。</p>
</li>
<li><p>Worker(JVM虚拟机): 指一个node上相互独立运行的JVM进程。每一个node可以配置运行一个或者多个worker。一个top会分配到一个或者多个worker上运行。  </p>
</li>
<li><p>Executor(线程):指一个worker的JVM进程中运行的Java线程。多个task可以指派给同一个executor来执行。除非是明确指定，Storm默认会给每一个executor分配一个task。</p>
</li>
<li><p>Task(Spout/bolt实例):task是spout和bolt的实例，它们的nextTuple（）和execute（）方法会被executor线程调用执行。task代表最大并发度。executor数代表实际并发数。</p>
</li>
</ul>
<p>###Storm并发<br><img src="/uploads/2016/10/9DD2F949-EADB-41FD-BE40-CB1DBB59D2D4.png" alt=""><br>并发举例</p>
<p>Config conf = new Config();<br>//设置两个worker<br>conf.setNumWorkers(2);<br>//spout数目线程数2<br>topologyBuilder.setSpout(“blue-spout”, new BlueSpout(),2);<br>//线程数为2，并发度为4   见图<br>topologyBuilder.setBolt(“green-bolt”, new GreenBolt(), 2).setNumTasks(4).shuffleGrouping(“blue-spout”);<br>//线程数为6<br>topologyBuilder.setBolt(“yellow-bolt”, new YellowBolt(), 6).shuffleGrouping(“green-bolt”);<br>StormSubmitter.submitTopology(<br>        “mytopology”,<br>        conf,<br>    topologyBuilder.createTopology()<br>    );</p>
<p>###Storm分组方式<br>数据流分组定义了一个数据流中的tuple如何发送给top中不同bolt的task。<br>注：不是一个spout或bolt emit到多个bolt（广播方式）<br>目前官方有八种</p>
<ul>
<li><p>Shuffle Grouping(随机分组)：这种方式会随机分发tuple给bolt的各个task，每个bolt实例接收到的相同数量的tuple。</p>
</li>
<li><p>Field Grouping(按字段分组)：根据指定的字段进行分组。（重点）</p>
</li>
<li><p>Non Grouping: 无分组， 这种分组和Shuffle grouping是一样的效果，多线程下不平均分配。</p>
</li>
<li><p>All Grouping： 广播发送。The stream is replicated across all the bolt’s tasks. Use this grouping with care.</p>
</li>
<li><p>Global Grouping: 全局分组， 这个tuple被分配到storm中的一个bolt的其中一个task。再具体一点就是分配给id值最低的那个task。适合场景：想象不到。</p>
</li>
<li><p>Direct Grouping: 直接分组， 这是一种比较特别的分组方法，用这种分组意味着消息的发送者决定由消息接收者的哪个task处理这个消息。 只有被声明为Direct Stream的消息流可以声明这种分组方法。而且这种消息tuple必须使用emitDirect方法来发射。消息处理者可以通过TopologyContext来或者处理它的消息的taskid (OutputCollector.emit方法也会返回taskid)</p>
</li>
<li><p>Partial Key grouping: The stream is partitioned by the fields specified in the grouping, like the Fields grouping, but are load balanced between two downstream bolts, which provides better utilization of resources when the incoming data is skewed. This paper provides a good explanation of how it works and the advantages it provides.（最新新增）</p>
</li>
<li><p>Local or shuffle grouping: If the target bolt has one or more tasks in the same worker process, tuples will be shuffled to just those in-process tasks. Otherwise, this acts like a normal shuffle grouping.</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpeg"
               alt="ddup" />
          <p class="site-author-name" itemprop="name">ddup</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="mailto:ddupsl@163.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                  Email
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/pslzym" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ddup</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="local-search-pop-overlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


  

</body>
</html>
