<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Ddup">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Ddup">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ddup">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title> Ddup </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ddup</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/08/stormshi-wu-pi-chu-li-yuan-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/08/stormshi-wu-pi-chu-li-yuan-li/" itemprop="url">
                  Storm事务-批处理原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-08T13:54:36+08:00">
                2016-10-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm事务-批处理原理</p>
<ol>
<li><p>事务<br>对于容错机制，Storm通过一个系统级别的组件acker，判断tuple是否发送成功，进而spout可以重发该tuple，保证一个tuple在出错的情况下至少被重发一次。<br>但是在需要精确统计tuple的场景下（销售金额），希望每个tuple“被且仅被处理一次”。storm引入了Transactional Topology。它可以保证每一个“tuple”被且仅被处理一次，这样就可以实现一种非常准确，且高度容错方式来实现计数类应用。</p>
</li>
<li><p>批处理<br>逐个处理单个tuple，增加很多开销，如写库、输出结果频率过高。事务处理单个tuple效率比较低，因此storm中引入batch处理。<br>批处理是一次性处理一批（batch）tuple，事务可以确保该批次要么全部处理成功，如果有处理失败的则全部不计，Storm会对失败的批次重新发送，且确保每一个batch被且仅被处理一次。</p>
</li>
</ol>
<p>###事务机制和原理<br>对于只处理一次的需要，从原理上来讲，需要在发送tuple的时候带上，txid，在需要事务处理的时候，根据该txid是否以前已经处理成功来决定是否进行处理，当然需要把txid和处理结果一起做保存。<br>在事务batch处理中，一批tuple赋予一个txid，为了提高batch之间处理的并行度，storm采用了pipeline处理模型，这样多个事务可以并行执行，但是commit的是严格按照顺序的。</p>
<p>Storm事务处理中，把一个batch的计算分成两个阶段processing和commit阶段：<br>processing阶段：多个batch可以并行计算。<br>commit阶段：batch之间强制按照顺序进行提交。<br><img src="/uploads/2016/10/--1.png" alt=""></p>
<p>####事务Topologies<br>使用Transactional Topologies的时候，storm为你做下面这些事情。</p>
<ul>
<li>管理状态：Storm把所有实现Transactional Topologies所必须的状态保存在zookeeper里面，包括当前transaction id 以及定义每一个batch的一些元数据。</li>
<li>协调事务：Storm帮你管理所有事情，如帮你决定在任何一个时间点是该processing还是该committing.</li>
<li>错误检测: Storm利用acking框架来高效地检测什么时候一个batch被成功处理了，被成功提交了，或者失败了。Storm然后会相应地replay对应的batch。你不需要自己手    动做任何acking或者anchoring (emit时发生的动作)。</li>
<li>内置的批处理API: Storm在普通bolt之上包装了一层API来提供对tuple的批处理支持。Storm管理所有的协调工作，包括决定什么时候一个bolt接收到一个特定transaction的所有tuple。Storm同时也会自动清理每个transaction所产生的中间数据。</li>
</ul>
<p>事务性的spout需要实现ITransactionalSpout，这个接口包含两个内部接口类Coordinator和Emitter。在topology运行的时候，事务性的spout内部包含一个子Topology，结构图如下：</p>
<p><img src="/uploads/2016/10/--2.png" alt=""></p>
<p>这里面有两种类型的tuple，一种是事务性的tuple，一种是batch中的tuple；<br>coordinator 开启一个事务准备发射一个batch时候，进入一个事务的processing阶段，会发射一个事务性 tuple(transactionAttempt &amp; metadata)到”batch emit”流</p>
<p>Emitter以all grouping(广播)的方式订阅coordinator的”batch emit”流，负责为每个batch实际发射tuple。发送的tuple都必须以TransactionAttempt作为第一个field，storm根据这个field来判断tuple属于哪一个batch。</p>
<p>coordinator只有一个，emitter根据并行度可以有多个实例</p>
<p>coordinator只有一个，emitter根据并行度可以有多个实例</p>
<p>####TransactionAttempt 和 元数据</p>
<p>TransactionAttempt包含两个值：一个transaction id，一个attempt id。transaction id的作用就是我们上面介绍的对于每个batch中的tuple是唯一的，而且不管这个batch    replay多少次都是一样的。<br>attempt id是对于每个batch唯一的一个id， 但是对于同一个batch，它replay之后的attempt id跟replay之前就不一样了，<br>我们可以把attempt id理解成replay-times， storm利用这个id来区别一个batch发射的tuple的不同版本</p>
<p>metadata(元数据)中包含当前事务可以从哪个point进行重放数据，存放在zookeeper中的，spout可以通过Kryo从zookeeper中序列化和反序列化该元数据。</p>
<p><img src="/uploads/2016/10/--3.png" alt=""><br>内部处理流程</p>
<p>####事务性Bolt</p>
<ul>
<li>BaseTransactionalBolt处理batch在一起的tuples，对于每一个tuple调用调用execute方 法，而在整个batch处理(processing)完成的时候调用finishBatch方法。如果BatchBolt被标记成Committer，则 只能在commit阶段调用finishBatch方法。一个batch的commit阶段由storm保证只在前一个batch成功提交之后才会执行。并且它会重试直到topology里面的所有bolt在commit完成提交。那么如何知道batch的processing完成了，也就是bolt是否接收处理了batch里面所有的tuple；在bolt内部，有一个 CoordinatedBolt的模型。<br>CoordinateBolt具体原理如下：</li>
</ul>
<p><img src="/uploads/2016/10/--4.png" alt=""></p>
<p>每个CoordinateBolt记录两个值：有哪些task给我发送了tuple（根据topology的grouping信息）；我要给哪些task发送信息（同样根据groping信息）。</p>
<p>等所有的tuple都发送完了之后，CoordinateBolt通过另外一个特殊的stream以emitDirect的方式告诉所有它发送过 tuple的task，它发送了多少tuple给这个task。下游task会将这个数字和自己已经接收到的tuple数量做对比，如果相等，则说明处理 完了所有的tuple。</p>
<p>下游CoordinateBolt会重复上面的步骤，通知其下游。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/07/stormke-kao-xing-chu-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/07/stormke-kao-xing-chu-li/" itemprop="url">
                  Storm可靠性处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-07T00:56:31+08:00">
                2016-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm可靠性处理</p>
<ul>
<li>spout可靠性处理</li>
<li>bolt可靠性处理</li>
</ul>
<p>###spout可靠性处理<br>以单词计算的例子为例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.IRichBolt;</span><br><span class="line">import org.apache.storm.topology.IRichSpout;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line">import org.apache.storm.utils.Utils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.UUID;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SentenceSpout extends BaseRichSpout &#123;</span><br><span class="line"></span><br><span class="line">    private SpoutOutputCollector spoutOutputCollector = null;</span><br><span class="line">    private ConcurrentHashMap&lt;UUID, Values&gt; pending;</span><br><span class="line"></span><br><span class="line">    private String [] sentence = &#123;</span><br><span class="line">        &quot;my dog has fleas&quot;,</span><br><span class="line">            &quot;I like cold beverages&quot;,</span><br><span class="line">            &quot;the dog ate my homework&quot;,</span><br><span class="line">            &quot;don&apos;t have a cow man&quot;,</span><br><span class="line">            &quot;i don&apos;t think i like fleas&quot;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    private  int index = 0;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;sentence&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void open(Map map, TopologyContext topologyContext, SpoutOutputCollector spoutOutputCollector) &#123;</span><br><span class="line">        this.spoutOutputCollector = spoutOutputCollector;</span><br><span class="line">        this.pending = new ConcurrentHashMap&lt;UUID, Values&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void nextTuple() &#123;</span><br><span class="line">        UUID msgId = UUID.randomUUID();</span><br><span class="line">        ///发送时必须带上msgId</span><br><span class="line">        this.spoutOutputCollector.emit(new Values(sentence[index]), msgId);</span><br><span class="line"></span><br><span class="line">        this.pending.put(msgId, new Values(sentence[index]));</span><br><span class="line"></span><br><span class="line">        index++;</span><br><span class="line">        if(index &gt;= sentence.length)&#123;</span><br><span class="line">            index = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void ack(Object msgId) &#123;</span><br><span class="line">        System.err.println(&quot;spout ack&quot;);</span><br><span class="line">        this.pending.remove(msgId);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void fail(Object msgId) &#123;</span><br><span class="line">        this.spoutOutputCollector.emit(this.pending.get(msgId), msgId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###bolt可靠性处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SplitSentenceBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private OutputCollector outputCollector = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.outputCollector = outputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String sentence = tuple.getStringByField(&quot;sentence&quot;);</span><br><span class="line">        String [] words = sentence.split(&quot; &quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;splitSentence : &quot; + sentence);</span><br><span class="line"></span><br><span class="line">        for (String word : words)&#123;</span><br><span class="line">            //发送时必须带上 tuple</span><br><span class="line">            this.outputCollector.emit(tuple, new Values(word));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.outputCollector.ack(tuple);</span><br><span class="line">        System.err.println(&quot;split ack&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;word&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面接着的bolt必须全部都加上tuple向后发送，并且处理完成后，显示的调用ack方法。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/07/stormdan-ci-ji-shu-shi-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/07/stormdan-ci-ji-shu-shi-li/" itemprop="url">
                  Storm单词计数示例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-07T00:30:43+08:00">
                2016-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm单词计数示例</p>
<ul>
<li>top代码</li>
<li>spout代码</li>
<li>bolt代码</li>
<li>遇到的bug</li>
</ul>
<p>###top代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.Config;</span><br><span class="line">import org.apache.storm.LocalCluster;</span><br><span class="line">import org.apache.storm.StormSubmitter;</span><br><span class="line">import org.apache.storm.generated.AlreadyAliveException;</span><br><span class="line">import org.apache.storm.generated.AuthorizationException;</span><br><span class="line">import org.apache.storm.generated.InvalidTopologyException;</span><br><span class="line">import org.apache.storm.topology.TopologyBuilder;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.utils.Utils;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/6/16.</span><br><span class="line"> */</span><br><span class="line">public class WordCountTopology &#123;</span><br><span class="line"></span><br><span class="line">    private static final String SENTENCE_SPOUT_ID = &quot;sentence-spout&quot;;</span><br><span class="line">    private static final String SPLIT_BOLT_ID = &quot;split-bolt&quot;;</span><br><span class="line">    private static final String COUNT_BOLT_ID = &quot;count-bolt&quot;;</span><br><span class="line">    private static final String REPORT_BOLT_ID = &quot;report-bolt&quot;;</span><br><span class="line">    private static final String TOPOLOGY_NAME = &quot;word-count-topology&quot;;</span><br><span class="line"></span><br><span class="line">    public static void main(String [] args) throws InvalidTopologyException, AuthorizationException, AlreadyAliveException &#123;</span><br><span class="line">        SentenceSpout sentenceSpout = new SentenceSpout();</span><br><span class="line">        SplitSentenceBolt splitSentenceBolt = new SplitSentenceBolt();</span><br><span class="line">        WordCountBolt wordCountBolt = new WordCountBolt();</span><br><span class="line">        ReportBolt reportBolt = new ReportBolt();</span><br><span class="line"></span><br><span class="line">        TopologyBuilder builder = new TopologyBuilder();</span><br><span class="line"></span><br><span class="line">        builder.setSpout(SENTENCE_SPOUT_ID, sentenceSpout);//, 2);</span><br><span class="line"></span><br><span class="line">        builder.setBolt(SPLIT_BOLT_ID, splitSentenceBolt, 2).setNumTasks(4).shuffleGrouping(SENTENCE_SPOUT_ID);</span><br><span class="line">        //builder.setBolt(SPLIT_BOLT_ID, splitSentenceBolt).shuffleGrouping(SENTENCE_SPOUT_ID);</span><br><span class="line"></span><br><span class="line">        builder.setBolt(COUNT_BOLT_ID, wordCountBolt, 6).fieldsGrouping(SPLIT_BOLT_ID, new Fields(&quot;word&quot;));</span><br><span class="line">        //builder.setBolt(COUNT_BOLT_ID, wordCountBolt).fieldsGrouping(SPLIT_BOLT_ID, new Fields(&quot;word&quot;));</span><br><span class="line"></span><br><span class="line">        builder.setBolt(REPORT_BOLT_ID, reportBolt).globalGrouping(COUNT_BOLT_ID);</span><br><span class="line"></span><br><span class="line">        Config config = new Config();</span><br><span class="line">        //config.setNumWorkers(2);</span><br><span class="line"></span><br><span class="line">        if (args.length == 0) &#123;</span><br><span class="line"></span><br><span class="line">            LocalCluster cluster = new LocalCluster();</span><br><span class="line"></span><br><span class="line">            cluster.submitTopology(TOPOLOGY_NAME, config, builder.createTopology());</span><br><span class="line">            //StormSubmitter.submitTopology(TOPOLOGY_NAME, config, builder.createTopology());</span><br><span class="line"></span><br><span class="line">            Utils.sleep(20000);</span><br><span class="line"></span><br><span class="line">            cluster.killTopology(TOPOLOGY_NAME);</span><br><span class="line"></span><br><span class="line">            cluster.shutdown();</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            StormSubmitter.submitTopology(args[0], config, builder.createTopology());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###spout代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.IRichBolt;</span><br><span class="line">import org.apache.storm.topology.IRichSpout;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line">import org.apache.storm.utils.Utils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SentenceSpout extends BaseRichSpout &#123;</span><br><span class="line"></span><br><span class="line">    private SpoutOutputCollector spoutOutputCollector = null;</span><br><span class="line"></span><br><span class="line">    private String [] sentence = &#123;</span><br><span class="line">        &quot;my dog has fleas&quot;,</span><br><span class="line">            &quot;I like cold beverages&quot;,</span><br><span class="line">            &quot;the dog ate my homework&quot;,</span><br><span class="line">            &quot;don&apos;t have a cow man&quot;,</span><br><span class="line">            &quot;i don&apos;t think i like fleas&quot;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    private  int index = 0;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;sentence&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void open(Map map, TopologyContext topologyContext, SpoutOutputCollector spoutOutputCollector) &#123;</span><br><span class="line">        this.spoutOutputCollector = spoutOutputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void nextTuple() &#123;</span><br><span class="line">        this.spoutOutputCollector.emit(new Values(sentence[index]));</span><br><span class="line"></span><br><span class="line">        index++;</span><br><span class="line">        if(index &gt;= sentence.length)&#123;</span><br><span class="line">            index = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.sleep(1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###bolt代码<br>splitSentenceBolt.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class SplitSentenceBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private OutputCollector outputCollector = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.outputCollector = outputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String sentence = tuple.getStringByField(&quot;sentence&quot;);</span><br><span class="line">        String [] words = sentence.split(&quot; &quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;splitSentence : &quot; + sentence);</span><br><span class="line"></span><br><span class="line">        for (String word : words)&#123;</span><br><span class="line">            this.outputCollector.emit(new Values(word));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;word&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WordCountBolt.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class WordCountBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private OutputCollector outputCollector = null;</span><br><span class="line">    private HashMap&lt;String, Long&gt; counts = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.outputCollector = outputCollector;</span><br><span class="line">        this.counts = new HashMap&lt;String, Long&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String word = tuple.getStringByField(&quot;word&quot;);</span><br><span class="line">        Long count = this.counts.get(word);</span><br><span class="line">        if(count == null)&#123;</span><br><span class="line">            count = 0L;</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">        this.counts.put(word, count);</span><br><span class="line">        this.outputCollector.emit(new Values(word, count));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;word&quot;, &quot;count&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReportBolt.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package org.pslland;</span><br><span class="line"></span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line"></span><br><span class="line">import java.util.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 10/5/16.</span><br><span class="line"> */</span><br><span class="line">public class ReportBolt extends BaseRichBolt &#123;</span><br><span class="line"></span><br><span class="line">    private HashMap&lt;String, Long&gt; counts = null;</span><br><span class="line"></span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.counts = new HashMap&lt;String, Long&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        String word = tuple.getStringByField(&quot;word&quot;);</span><br><span class="line">        Long count = tuple.getLongByField(&quot;count&quot;);</span><br><span class="line"></span><br><span class="line">        this.counts.put(word, count);</span><br><span class="line"></span><br><span class="line">        //this.cleanup();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        //last bolt</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void cleanup()&#123;</span><br><span class="line">        System.out.println(&quot;----------- FINAL COUNTS -----------&quot;);</span><br><span class="line">        List&lt;String&gt; keys = new ArrayList&lt;String&gt;();</span><br><span class="line">        keys.addAll(this.counts.keySet());</span><br><span class="line"></span><br><span class="line">        Collections.sort(keys);</span><br><span class="line"></span><br><span class="line">        for (String key : keys)&#123;</span><br><span class="line">            System.out.println(key + &quot; : &quot; + this.counts.get(key));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;-----------------------------------&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###遇到的bug<br>我的代码是通过IDEA打包的。相关maven配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br></pre></td></tr></table></figure>
<pre><code>&lt;groupId&gt;org.pslland&lt;/groupId&gt;
&lt;artifactId&gt;stormWC&lt;/artifactId&gt;
&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.storm&lt;/groupId&gt;
        &lt;artifactId&gt;storm-core&lt;/artifactId&gt;
        &lt;version&gt;1.0.2&lt;/version&gt;
        &lt;!--&lt;scope&gt;provided&lt;/scope&gt;--&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre><p></p>
<p></p>
<p>本地调试的时候去掉<scope>provided</scope>标签。</p>
<p>在集群提交测试的时候如果编译没有加上provided 标签会产生如下错误：<br>Caused by: java.io.IOException: Found multiple defaults.yaml resources. </p>
<p>集群提交命令：<br>./storm  jar 包名  类名  参数</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/07/stormfen-zu-fang-shi-he-bing-fa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/07/stormfen-zu-fang-shi-he-bing-fa/" itemprop="url">
                  Storm分组方式和并发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-07T00:16:54+08:00">
                2016-10-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm分组方式和并发</p>
<ul>
<li>基础理论</li>
<li>Storm分组方式</li>
<li>Storm并发</li>
</ul>
<p>###基础理论</p>
<ul>
<li><p>Nodes(服务器):指配置在一个Storm集群中的服务器，会执行top的一部分运算。一个Storm集群可以包括一个或者多个工作node。</p>
</li>
<li><p>Worker(JVM虚拟机): 指一个node上相互独立运行的JVM进程。每一个node可以配置运行一个或者多个worker。一个top会分配到一个或者多个worker上运行。  </p>
</li>
<li><p>Executor(线程):指一个worker的JVM进程中运行的Java线程。多个task可以指派给同一个executor来执行。除非是明确指定，Storm默认会给每一个executor分配一个task。</p>
</li>
<li><p>Task(Spout/bolt实例):task是spout和bolt的实例，它们的nextTuple（）和execute（）方法会被executor线程调用执行。task代表最大并发度。executor数代表实际并发数。</p>
</li>
</ul>
<p>###Storm并发<br><img src="/uploads/2016/10/9DD2F949-EADB-41FD-BE40-CB1DBB59D2D4.png" alt=""><br>并发举例</p>
<p>Config conf = new Config();<br>//设置两个worker<br>conf.setNumWorkers(2);<br>//spout数目线程数2<br>topologyBuilder.setSpout(“blue-spout”, new BlueSpout(),2);<br>//线程数为2，并发度为4   见图<br>topologyBuilder.setBolt(“green-bolt”, new GreenBolt(), 2).setNumTasks(4).shuffleGrouping(“blue-spout”);<br>//线程数为6<br>topologyBuilder.setBolt(“yellow-bolt”, new YellowBolt(), 6).shuffleGrouping(“green-bolt”);<br>StormSubmitter.submitTopology(<br>        “mytopology”,<br>        conf,<br>    topologyBuilder.createTopology()<br>    );</p>
<p>###Storm分组方式<br>数据流分组定义了一个数据流中的tuple如何发送给top中不同bolt的task。<br>注：不是一个spout或bolt emit到多个bolt（广播方式）<br>目前官方有八种</p>
<ul>
<li><p>Shuffle Grouping(随机分组)：这种方式会随机分发tuple给bolt的各个task，每个bolt实例接收到的相同数量的tuple。</p>
</li>
<li><p>Field Grouping(按字段分组)：根据指定的字段进行分组。（重点）</p>
</li>
<li><p>Non Grouping: 无分组， 这种分组和Shuffle grouping是一样的效果，多线程下不平均分配。</p>
</li>
<li><p>All Grouping： 广播发送。The stream is replicated across all the bolt’s tasks. Use this grouping with care.</p>
</li>
<li><p>Global Grouping: 全局分组， 这个tuple被分配到storm中的一个bolt的其中一个task。再具体一点就是分配给id值最低的那个task。适合场景：想象不到。</p>
</li>
<li><p>Direct Grouping: 直接分组， 这是一种比较特别的分组方法，用这种分组意味着消息的发送者决定由消息接收者的哪个task处理这个消息。 只有被声明为Direct Stream的消息流可以声明这种分组方法。而且这种消息tuple必须使用emitDirect方法来发射。消息处理者可以通过TopologyContext来或者处理它的消息的taskid (OutputCollector.emit方法也会返回taskid)</p>
</li>
<li><p>Partial Key grouping: The stream is partitioned by the fields specified in the grouping, like the Fields grouping, but are load balanced between two downstream bolts, which provides better utilization of resources when the incoming data is skewed. This paper provides a good explanation of how it works and the advantages it provides.（最新新增）</p>
</li>
<li><p>Local or shuffle grouping: If the target bolt has one or more tasks in the same worker process, tuples will be shuffled to just those in-process tasks. Otherwise, this acts like a normal shuffle grouping.</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/05/stormshi-li-cheng-xu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/05/stormshi-li-cheng-xu/" itemprop="url">
                  Storm示例程序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-05T16:04:21+08:00">
                2016-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Storm示例程序</p>
<ul>
<li>测试数据</li>
<li>Spout程序</li>
<li>Bolt程序</li>
<li>主程序</li>
</ul>
<p>###测试数据<br>由于是简单的示例测试程序，我直接弄了一个代码生成了相关的数据文件。<br>最后文件数据的格式如下：<br><code><br>www.pslland.org    CYYH6Y2345GHI899OFG4V9U567    2014-01-07 11:40:49<br>www.taobao.com    XXYH6YCGFJYERTT834R52FDXV9U34    2014-01-07 08:40:50<br>www.taobao.com    CYYH6Y2345GHI899OFG4V9U567    2014-01-07 09:40:49<br>www.taobao.com    BBYH61456FGHHJ7JL89RG5VV9UYU7    2014-01-07 08:40:53<br>www.taobao.com    VVVYH6Y4V4SFXZ56JIPDPB4V678    2014-01-07 10:40:49<br>www.taobao.com    ABYH6Y4V4SCVXTG6DPB4VH9U123    2014-01-07 08:40:50<br>www.taobao.com    CYYH6Y2345GHI899OFG4V9U567    2014-01-07 11:40:49<br>www.pslland.org    XXYH6YCGFJYERTT834R52FDXV9U34    2014-01-07 08:40:52<br></code><br>行数自己控制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.Random;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 9/24/16.</span><br><span class="line"> */</span><br><span class="line">public class genrateData &#123;</span><br><span class="line">    public static void main(String [] argv)&#123;</span><br><span class="line">        File logFile = new File(&quot;test.log&quot;);</span><br><span class="line"></span><br><span class="line">        Random random = new Random();</span><br><span class="line"></span><br><span class="line">        String [] hosts = &#123;&quot;www.pslland.org&quot;, &quot;www.taobao.com&quot;&#125;;</span><br><span class="line"></span><br><span class="line">        String [] sessions = &#123;&quot;ABYH6Y4V4SCVXTG6DPB4VH9U123&quot;, &quot;XXYH6YCGFJYERTT834R52FDXV9U34&quot;, &quot;BBYH61456FGHHJ7JL89RG5VV9UYU7&quot;,</span><br><span class="line">                &quot;CYYH6Y2345GHI899OFG4V9U567&quot;, &quot;VVVYH6Y4V4SFXZ56JIPDPB4V678&quot;&#125;;</span><br><span class="line">        String [] time = &#123;&quot;2014-01-07 08:40:50&quot;, &quot;2014-01-07 08:40:51&quot;, &quot;2014-01-07 08:40:52&quot;, &quot;2014-01-07 08:40:53&quot;,</span><br><span class="line">                &quot;2014-01-07 09:40:49&quot;, &quot;2014-01-07 10:40:49&quot;, &quot;2014-01-07 11:40:49&quot;, &quot;2014-01-07 12:40:49&quot;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        StringBuffer stringBuffer = new StringBuffer();</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; 50; i++)&#123;</span><br><span class="line">            stringBuffer.append(hosts[random.nextInt(2)] + &apos;\t&apos; + sessions[random.nextInt(5)] + &apos;\t&apos; + time[random.nextInt(8)] + &apos;\n&apos;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!logFile.exists())&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                logFile.createNewFile();</span><br><span class="line">            &#125;catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputStream fs = null;</span><br><span class="line">        byte [] b = (stringBuffer.toString()).getBytes();</span><br><span class="line">        try &#123;</span><br><span class="line">            fs = new FileOutputStream(logFile);</span><br><span class="line">            fs.write(b);</span><br><span class="line">            fs.close();</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###Spout程序</p>
<p><img src="/uploads/2016/10/spout1.png" alt=""><br>类继承图</p>
<p><img src="/uploads/2016/10/spout2.png" alt=""><br>ISpout接口</p>
<p>Spout程序层抽象是ISpout接口<br>Open()是初始化方法<br>nextTuple()循环发射数据<br>ack() 成功处理tuple回调方法<br>Fail()处理失败tuple回调方法<br>activate和deactivate ：spout可以被暂时激活和关闭<br>close方法在该spout关闭前执行，<br>但是并不能得到保证其一定被执行，kill -9时不执行，<br>Storm kill {topoName} 时执行</p>
<p>原则：通常情况下（Shell和事务型的除外），实现一个Spout，可以直接实现接口IRichSpout，如果不想写多余的代码，可以直接继承BaseRichSpout。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.IRichSpout;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Values;</span><br><span class="line"></span><br><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 9/24/16.</span><br><span class="line"> */</span><br><span class="line">public class mySpout implements IRichSpout&#123;</span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;LOG&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Object&gt; getComponentConfiguration() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SpoutOutputCollector spoutOutputCollector = null;</span><br><span class="line">    FileInputStream fs = null;</span><br><span class="line">    InputStreamReader isr = null;</span><br><span class="line">    BufferedReader br;</span><br><span class="line"></span><br><span class="line">    public void open(Map map, TopologyContext topologyContext, SpoutOutputCollector spoutOutputCollector) &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            this.spoutOutputCollector = spoutOutputCollector;</span><br><span class="line">            this.fs = new FileInputStream(&quot;test.log&quot;);</span><br><span class="line">            this.isr = new InputStreamReader(fs, &quot;UTF-8&quot;);</span><br><span class="line">            this.br = new BufferedReader(isr);</span><br><span class="line"></span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void close() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.br.close();</span><br><span class="line">            this.isr.close();</span><br><span class="line">            this.fs.close();</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void activate() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void deactivate() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String str = null;</span><br><span class="line">    public void nextTuple() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            while ((str = this.br.readLine()) != null)&#123;</span><br><span class="line">                spoutOutputCollector.emit(new Values(str));</span><br><span class="line">                Thread.sleep(3000);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch ( Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void ack(Object o) &#123;</span><br><span class="line">        System.out.println(&quot;spout ack: &quot; + o.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void fail(Object o) &#123;</span><br><span class="line">        System.out.println(&quot;spout fail: &quot; + o.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###Bolt程序</p>
<p><img src="/uploads/2016/10/bolt1.png" alt=""><br>Bolt类继承图</p>
<p><img src="/uploads/2016/10/bolt2.png" alt=""><br>IBolt方法</p>
<p>prepare方法进行初始化，<br>传入当前执行的上下文<br>execute接受一个tuple进行处理，<br>也可emit数据到下一级组件<br>cleanup 同ISpout的close方法，在关闭前调用，<br>不保证其一定执行。</p>
<p>IBolt继承了Serializable，我们在nimbus上提交了topology以后，创建出来的bolt会序列化后发送到具体执行的worker(工作进程)上去。worker在执行该Bolt时，会先调用prepare方法传入当前执行的上下文.<br>execute接受一个tuple进行处理，并用prepare方法传入的OutputCollector的ack方法（表示成功）或fail（表示失败）来反馈处理结果.还可以通过OutputCollector的emit方法把结果发射到下一级组件。</p>
<p>IBasicBolt接口，实现该接口的Bolt不用在代码中提供反馈结果了，Storm内部会自动反馈成功。如果你确实要反馈失败，可以抛出FailedException。</p>
<p>（后续章节讲到的Trident均不用显性调用ack和fail，框架会自动调。）</p>
<p>实现一个Bolt，可以实现IRichBolt接口或继承BaseRichBolt，如果不想自己处理结果反馈，可以实现 IBasicBolt接口或继承BaseBasicBolt，它实际上相当于自动做了prepare方法和 collector.emit.ack(inputTuple)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.storm.task.IBolt;</span><br><span class="line">import org.apache.storm.task.OutputCollector;</span><br><span class="line">import org.apache.storm.task.TopologyContext;</span><br><span class="line">import org.apache.storm.topology.IRichBolt;</span><br><span class="line">import org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line">import org.apache.storm.tuple.Fields;</span><br><span class="line">import org.apache.storm.tuple.Tuple;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 9/24/16.</span><br><span class="line"> */</span><br><span class="line">public class mybolt implements IRichBolt&#123;</span><br><span class="line"></span><br><span class="line">    OutputCollector outputCollector = null;</span><br><span class="line">    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) &#123;</span><br><span class="line">        this.outputCollector = outputCollector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String valueString = null;</span><br><span class="line">    int num = 0;</span><br><span class="line">    public void execute(Tuple tuple) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            valueString = tuple.getStringByField(&quot;LOG&quot;);</span><br><span class="line">            if(valueString != null)&#123;</span><br><span class="line">                num++;</span><br><span class="line">                System.err.println(Thread.currentThread().getName() + &quot;   line : &quot; + num + &quot;   sessionId : &quot; + valueString.split(&quot;\t&quot;)[1]);</span><br><span class="line">            &#125;</span><br><span class="line">            outputCollector.ack(tuple);</span><br><span class="line">            Thread.sleep(2000);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            outputCollector.fail(tuple);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void cleanup() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) &#123;</span><br><span class="line">        outputFieldsDeclarer.declare(new Fields(&quot;&quot;));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Object&gt; getComponentConfiguration() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###主程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.storm.Config;</span><br><span class="line">import org.apache.storm.LocalCluster;</span><br><span class="line">import org.apache.storm.StormSubmitter;</span><br><span class="line">import org.apache.storm.topology.TopologyBuilder;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by psl on 9/24/16.</span><br><span class="line"> */</span><br><span class="line">public class main &#123;</span><br><span class="line">    public static void main(String [] argv)&#123;</span><br><span class="line">        TopologyBuilder topologyBuilder = new TopologyBuilder();</span><br><span class="line"></span><br><span class="line">        topologyBuilder.setSpout(&quot;spout&quot;, new mySpout(), 1);</span><br><span class="line">        topologyBuilder.setBolt(&quot;bolt&quot;, new mybolt(), 1).shuffleGrouping(&quot;spout&quot;);</span><br><span class="line"></span><br><span class="line">        Config conf = new Config() ;</span><br><span class="line">        conf.setDebug(true);</span><br><span class="line"></span><br><span class="line">        if (argv.length &gt; 0)&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                StormSubmitter.submitTopology(argv[0], conf, topologyBuilder.createTopology());</span><br><span class="line"></span><br><span class="line">            &#125;catch (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            LocalCluster localCluster = new LocalCluster();</span><br><span class="line">            localCluster.submitTopology(&quot;mytopology&quot;, conf, topologyBuilder.createTopology());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/04/hbasexie-chu-li-qi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/04/hbasexie-chu-li-qi/" itemprop="url">
                  Hbase协处理器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T18:23:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Hbase 协处理器<br>HBase 做为列数据库最令人诟病的特性包括：<br>无法轻易建立‘二级索引’，难以执行求和、计数、排序等操作。</p>
<p>为了减少在客服端做大量的运算，Hbase引入了coprocessor，能够轻易建立二次索引、复杂过滤器以及访问控制符等。</p>
<p>协处理器分为两种类型，系统协处理器可以全局导入region server上所有的数据表，表协处理器即是用户可以指定一张表使用协处理器。<br>协处理器为了提高灵活性，提供了两种不同的插件。一个是观察者模式（observer），类似与数据库的触发器。另一个是终端（endpoint）,动态的终端有点像存储过程。</p>
<ul>
<li>observer</li>
<li>endpoint</li>
</ul>
<p>###observer<br><img src="/uploads/2016/10/60b135e5-04c6-4197-b262-e7cd08de784b.png" alt=""><br>模型</p>
<p>以上的函数是比较老的，注意最新的代码。</p>
<p>Observer最新的类型有四种：</p>
<ul>
<li><p>RegionObserver: 提供客户端的数据操纵事件钩子:Get、Put、Delete、Scan等。</p>
</li>
<li><p>RegionServerObserver : A RegionServerObserver allows you to observe events related to the RegionServer’s operation, such as starting, stopping, or performing merges, commits, or rollbacks.  最新加的。</p>
</li>
<li><p>MasterObserver： 提供DDL-类型的操作钩子。如创建、删除、修改数据表等。 这些接口可以同时使用在同一个地方,按照不同优先级顺序执行.用户可以任意基于协处理 器实现复杂的HBase功能层。HBase有很多种事件可以触发观察者方法,这些事件与方法 从HBase0.92版本起,都会集成在HBase API中。不过这些API可能会由于各种原因有所改 动,不同版本的接口改动比较大。</p>
</li>
<li><p>WalObserver：提供WAL相关操作钩子。</p>
</li>
</ul>
<p>主要讨论RegionObserver相关代码的编写：</p>
<pre><code>public class RegionObserverTest extends BaseRegionObserver{

private static byte[] fixed_rowkey = Bytes.toBytes(&quot;0004&quot;);

@Override
public void preGetOp(ObserverContext&lt;RegionCoprocessorEnvironment&gt; e, Get get, List&lt;Cell&gt; results) throws IOException {
    if(Bytes.equals(get.getRow(), fixed_rowkey)){
        KeyValue keyValue = new KeyValue(get.getRow(), Bytes.toBytes(&quot;time&quot;), Bytes.toBytes(&quot;key_changed&quot;),
                Bytes.toBytes(&quot;value_changed&quot;));

        results.add(keyValue);

    }
}
}

在编写代码中遇到的问题：
    1.IDEA找不到BaseRegionObserver。这个是因为原先我们编写Hbase客服端程序只用到了hbase-client包，在编写coprocessor程序的时候需要导入hbase-server.
    \&lt;dependency&gt;
            \&lt;groupId&gt;org.apache.hbase\&lt;/groupId&gt;
            \&lt;artifactId&gt;hbase-server\&lt;/artifactId&gt;
            \&lt;version&gt;1.2.3\&lt;/version&gt;
  \&lt;/dependency&gt;
  2.程序正常导入表之后，scan出来的行没有变化。这个是因为此coprocessor只是针对get方法，使用get去获取某一行就OK。
</code></pre><p>如何使其正常运作。</p>
<ol>
<li>先将上述的代码打包生成一个jar文件。</li>
<li>将jar文件传入HDFS的一个相应的路径</li>
<li>disable 表 （disable ‘user_info’）</li>
<li>alter 修改表相关配置 （alter ‘user_info’, ‘coprocessor’=&gt;’hdfs:///coprocessor/hbaseRegionObserver.jar|org.pslland.RegionObserverTest||’）</li>
<li>enable相关表   （enable ‘user_info’）</li>
<li>get相关数据，检查是否生效    （get ‘user_info’, ‘0004’）</li>
</ol>
<p>###endpoint<br>endpoint常用于求和等高级功能，相关API在1.2.3里面改动比较大。相关例子参考：<br><a href="http://www.3pillarglobal.com/insights/hbase-coprocessors" target="_blank" rel="noopener">http://www.3pillarglobal.com/insights/hbase-coprocessors</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/04/hbaseguo-lu-qi-de-shi-yong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/04/hbaseguo-lu-qi-de-shi-yong/" itemprop="url">
                  HBase过滤器的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T10:53:27+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##HBsae 过滤器</p>
<ul>
<li>过滤器API</li>
</ul>
<p>###过滤器的使用</p>
<ol>
<li>使用过滤器可以提高操作表的效率,HBase中两种数据读取函数get()和scan()都支持过滤器,支持直接访问和通过指定起止行键来访问,但是缺少细粒度的筛选功能,如基于正则表达式对行键或值进行筛选的功能。</li>
<li>可以使用预定义好的过滤器或者是实现自定义过滤器</li>
<li>过滤器在客户端创建,通过RPC传送到服务器端,在服务器端执行过滤操作,把数据返回给客户端</li>
</ol>
<p><img src="/uploads/2016/10/QQ20161004-0.png" alt=""><br>原理图</p>
<p>不使用过滤器的情况下，scan可以通过设置开始行和结束行的方式进行过滤。（其中设置的条件是左闭右开）<br>scan ‘user_info’, {STARTROW=&gt;’0001’, ENDROW=&gt;’0003’}<br>缺少细粒度的筛选功能</p>
<p>####过滤器类型和名称</p>
<ol>
<li><p>Comparision Filters(比较过滤器) (主要针对行键名和列族名进行过滤)<br> RowFilter<br> FamilyFilter<br> QualifierFilter<br> ValueFilter<br> DependentColumnFilter</p>
</li>
<li><p>Dedicated Filters(专用过滤器)  （可以针对值进行过滤）<br> SingleColumnValueFilter<br> SingleColumnValueExcludeFilter<br> PrefixFilter<br> PageFilter<br> KeyOnlyFilter<br> FirstKeyOnlyFilter<br> TimestampsFilter<br> RandomRowFilter</p>
</li>
</ol>
<p>3.Decorating Filters(附加过滤器)<br>SkipFilter<br>WhileMatchFilters</p>
<p>####过滤器的使用<br>RowFilter—&gt;BinaryComparator,RegexStringComparator</p>
<pre><code>public static void filterTest(String tableName, Connection connection){
        Scan scan = new Scan();
        scan.setCaching(1000);
        ////BinaryComparator, BinaryPrefixComparator, BitComparator, LongComparator, NullComparator, RegexStringComparator, SubstringComparator
//        RowFilter rowFilter = new RowFilter(CompareFilter.CompareOp.EQUAL, new BinaryComparator(Bytes.toBytes(&quot;0001&quot;)));
        RowFilter rowFilter = new RowFilter(CompareFilter.CompareOp.EQUAL, new RegexStringComparator(&quot;000\\w+&quot;));


    scan.setFilter(rowFilter);

    System.out.println(&quot;test-----&quot;);

    try {
        Table table = connection.getTable(TableName.valueOf(tableName));
        ResultScanner scanner = table.getScanner(scan);
        for (Result result: scanner){
            System.out.println(result);
        }

    } catch (IOException e) {
        e.printStackTrace();
    }
}
</code></pre><p>PageFilter</p>
<pre><code>public static void PagefilterTest(String tableName, Connection connection){

    //scan.setCaching(1000);

    PageFilter pageFilter = new PageFilter(3);

    byte [] lastRow = null;

    int pageCount = 0;

    try {
        while (++pageCount &gt; 0){

            System.out.println(&quot;pageCount: &quot; + pageCount);
            Scan scan = new Scan();
            scan.setFilter(pageFilter);

            if (lastRow != null){
                scan.setStartRow(lastRow);
            }

            Table table = connection.getTable(TableName.valueOf(tableName));

            ResultScanner scanner = table.getScanner(scan);

            int count = 0;
            for (Result result: scanner){
                lastRow = result.getRow();

                //避免每一页最后一个row重复
                if(++count &gt;= 3){
                    break;
                }
                System.out.println(result);
            }

            ////处理最后一页
            if(count &lt; 3){
                break;
            }

        }
    } catch (IOException e) {
        e.printStackTrace();
    }
}
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/03/hbaseji-chu-apide-shi-yong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/03/hbaseji-chu-apide-shi-yong/" itemprop="url">
                  Hbase基础API的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-03T17:35:43+08:00">
                2016-10-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##HBsae API使用</p>
<ul>
<li>基础API</li>
<li>扫描器API</li>
</ul>
<p>###基础API 与 扫描器API<br>1.创建表</p>
<pre><code>    Configuration conf = new Configuration();
    conf.set(&quot;hbase.zookeeper.quorum&quot;, &quot;192.168.0.110:2181&quot;);

    Connection conn = null;
    conn = ConnectionFactory.createConnection(conf);

    HBaseAdmin hBaseAdmin = (HBaseAdmin)conn.getAdmin();

    createTable(&quot;tableName1&quot;, &quot;tst1&quot;, &quot;tst2&quot;, hBaseAdmin);

    public static  void createTable(String tableName, String column1, String column2, HBaseAdmin hBaseAdmin)throws IOException{

    //TableName tableName = new TableName();

    HTableDescriptor tableDescriptor = new HTableDescriptor(TableName.valueOf(tableName));

    tableDescriptor.addFamily(new HColumnDescriptor(column1));

    HColumnDescriptor hColumnDescriptor = new HColumnDescriptor(column2);

    hColumnDescriptor.setVersions(3, 3);

    tableDescriptor.addFamily(hColumnDescriptor);

    hBaseAdmin.createTable(tableDescriptor);

}
</code></pre><p>2.插入数据</p>
<pre><code>   Configuration conf = new Configuration();
   conf.set(&quot;hbase.zookeeper.quorum&quot;, &quot;192.168.0.110:2181&quot;);

   //HBaseAdmin hBaseAdmin = new HBaseAdmin(conf);
   Connection conn = null;
   conn = ConnectionFactory.createConnection(conf);

    putDatas(&quot;tableName1&quot;, conn);

    public static void putDatas(String tableName, Connection connection) throws  IOException{
    //String [] rows =
    Table table = connection.getTable(TableName.valueOf(tableName));

    Put put = new Put(&quot;rowKey1_psl01&quot;.getBytes());

    put.addColumn(&quot;tst1&quot;.getBytes(), &quot;tst1_key&quot;.getBytes(), &quot;tst1_value&quot;.getBytes());

    put.addColumn(&quot;tst2&quot;.getBytes(), &quot;tst2_key&quot;.getBytes(), &quot;tst2_value&quot;.getBytes());

    table.put(put);

}    
</code></pre><p>3.获取数据</p>
<pre><code>   Configuration conf = new Configuration();
   conf.set(&quot;hbase.zookeeper.quorum&quot;, &quot;192.168.0.110:2181&quot;);

   //HBaseAdmin hBaseAdmin = new HBaseAdmin(conf);
   Connection conn = null;
   conn = ConnectionFactory.createConnection(conf);

   getData(&quot;tableName1&quot;, conn);

public  static void getData(String tableName, Connection connection) throws  IOException{
    Get get = new Get(&quot;rowKey1_psl01&quot;.getBytes());
    get.addColumn(&quot;tst1&quot;.getBytes(), &quot;tst1_key&quot;.getBytes());

    Table table = connection.getTable(TableName.valueOf(tableName));

    Result result = table.get(get);

    List&lt;Cell&gt; cells = result.listCells();

    for (Cell cell : cells){
        System.out.println(&quot;qualifier : &quot; + new String(CellUtil.cloneQualifier(cell)));
        System.out.println(&quot;value: &quot; + new String(CellUtil.cloneValue(cell)));
    }
}
</code></pre><p> 4.删除数据</p>
<pre><code>    public  static void delData(String tableName, Connection connection) throws IOException{
    //hBaseAdmin.disableTable();
    Delete delete = new Delete(&quot;rowKey1_psl01&quot;.getBytes());

    delete.addColumn(&quot;tst1&quot;.getBytes(), &quot;tst1_key&quot;.getBytes());

    Table table = connection.getTable(TableName.valueOf(tableName));
    table.delete(delete);
}
</code></pre><p>  5.扫描表</p>
<pre><code>   public static void hbaseScan(String tableName, Connection connection){
    Scan scan = new Scan();
    scan.setCaching(1000);
    try {
        Table table = connection.getTable(TableName.valueOf(tableName));
        ResultScanner scanner = table.getScanner(scan);
        for (Result result: scanner){
            System.out.println(result);
        }

    } catch (IOException e) {
        e.printStackTrace();
    }
}
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/27/hbasedu-shu-ju-liu-cheng/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/27/hbasedu-shu-ju-liu-cheng/" itemprop="url">
                  Hbase读数据流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-27T23:12:50+08:00">
                2016-09-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Hbase读数据</p>
<ul>
<li>Hbase读数据流程<br>*Hbase -ROOT- 和 .META.表结构</li>
</ul>
<p>###Hbase读数据流程<br><img src="/uploads/2016/09/hbase------.png" alt=""><br>Hbase读数据流程图</p>
<pre><code>1.从zk里面获取-ROOT-表所在regionServer的信息。
2.访问-ROOT-表所在的RegionServer，找到所要查询表的记录的二级索引。
3.根据-ROOT-表里面的记录，查询对应的.META.表的regionServer，获取表真实记录所在的regionServer信息。
4.根据在.MATE.所获取的信息，查询表所在的regionServer，并获取相应的数据。
</code></pre><p>###Hbase -ROOT- 和 .MATE.表结构</p>
<p><img src="/uploads/2016/09/root.png" alt=""><br>ROOT表结构</p>
<p><img src="/uploads/2016/09/meta.png" alt=""><br>META表结构</p>
<p>两张表的结构类似，因为都是用于定位表的位置。仔细看看两张表的ROWKEY的定义，对表的位置定位基本上就清楚啦。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/25/hbasecun-chu-yuan-li-he-ji-chu-ming-ling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ddup">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ddup">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/25/hbasecun-chu-yuan-li-he-ji-chu-ming-ling/" itemprop="url">
                  Hbase存储原理和基础命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-25T01:48:27+08:00">
                2016-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Hbase原理和基础命令</p>
<ul>
<li>Hbase存储基本原理</li>
<li>Client端基础命令</li>
</ul>
<p>###Hbase存储基本原理</p>
<p><img src="/uploads/2016/09/Hbase1.png" alt=""><br>存储原理图</p>
<p><img src="/uploads/2016/09/Hbase2-1.png" alt=""><br>大表存储图</p>
<p>数据管理机制<br>1、hbase中的表很大—bigtable，都是分布式存储在集群的各个regionserver上</p>
<p>2、分布式存储时，需要对表进行切分，首先是按行切分成若干个hregion</p>
<p>3、表的每一个hregion都会被一个regionserver所管理</p>
<p>4、每一个hregion随着插入数据的增多，一旦达到一个阈值，会被regionserver分裂成两个</p>
<p>5、在一个hregion内部还会被按照列族切分成若干个store单元</p>
<p>6、每一个store又会被切分成若干个store file(HFile)存储到hdfs文件系统中</p>
<p>7、每一个store对象中会维护一个内存缓存 memstore，用户查询数据时首先会去memstore中进行命中</p>
<p>8、客户端往表中插入数据，首先会在hlog日志中进行记录，然后定期进行flush合并</p>
<p>###Client端基础语法</p>
<p><img src="/uploads/2016/09/Hbase3.png" alt=""></p>
<p><img src="/uploads/2016/09/Hbase4.png" alt=""><br>Hbase基础表结构</p>
<p>1.创建表的基础命令<br>    create ‘user_info’, ‘base_info’, ‘extra_info’;<br>    指定版本号：<br>    create ‘user_info’, {NAME =&gt;’base_info’, VERSION =&gt; 3}, ‘extra_info’</p>
<p>2.插入数据<br>    put ‘user_info’, ‘0001’, ‘base_info:phone’, ‘13967109402’<br>    put ‘user_info’, ‘0001’, ‘base_info:name’, ‘angleababy’</p>
<p>3.全表扫描<br>    scan ‘user_info’ </p>
<p>4.查看数据<br>    get ‘user_info’,’0001’, ‘base_info:name’, ‘base_info:age’<br>    get ‘user_info2’, ‘0001’, { COLUMN =&gt; ‘base_info:name’, VERSIONS =&gt; 4}   查看多个版本的数据</p>
<p>5.查看表的名称：<br>list</p>
<p>6.Hbase中数据库的概念，namespaces</p>
<pre><code>创建一个命名空间my_ns
create_namespace &apos;my_ns&apos;
在命名空间my_ns里创建my_table
create &apos;my_ns:my_table&apos;, &apos;fam&apos;
drop namespace
drop_namespace &apos;my_ns&apos;

alter namespace
alter_namespace &apos;my_ns&apos;, {METHOD =&gt; &apos;set&apos;, &apos;PROPERTY_NAME&apos; =&gt; &apos;PROPERTY_VALUE&apos;}
默认的namespace：
   default:一般没有定义名称空间的表都在default里面。
   hbase:里面存放的是Hbase的基础表（root,meta,namespace）
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpeg"
               alt="ddup" />
          <p class="site-author-name" itemprop="name">ddup</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="mailto:ddupsl@163.com" target="_blank" title="Email">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                  Email
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/pslzym" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ddup</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="local-search-pop-overlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


  

</body>
</html>
